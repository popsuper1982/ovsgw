qemu

sudo yum groupinstall "Development Tools"
sudo yum install -y cmake make ninja-build glib2 glib2-devel spice-server-devel spice-protocol usbredir-devel gcc
sudo yum install iasl  libssh-devel bzip2-devel  libepoxy-devel
sudo yum install libcap-ng-devel libdrm-devel
sudo yum install libbpf-devel libibumad-devel

编译与安装

$cd qemu-5.0.0
$./configure --enable-kvm --enable-debug --enable-vnc --enable-werror  --target-list="x86_64-softmmu"
$make -j8
$sudo make install

–enable-vnc 启用 VNC
–enable-kvm 编译 KVM 模块, 使 Qemu 可以利用 KVM  来访问硬件提供的虚拟化服务。
–enalbe-werror 编译时,将所有的警告当作错误处理。
–target-list 选择目标机器的架构。默认是将所有的架构都编译,但为了更快的完成编译,指定需要的架构即可.

安装好之后,会生成如下应用程序
ivshmem-client/server 这是一个 guest 和 host 共享内存的应用程序,遵循 C/S 的架构。
qemu-ga 这是一个不利用网络实现 guest 和 host 之间交互的应用程序,使用 virtio-serial,运行在 guest 中。
qemu-io 这是一个执行 Qemu I/O 操作的命令行工具。
qemu-system-x86_64 Qemu的核心应用程序,虚拟机就由它创建的。
qemu-img 创建虚拟机镜像文件的工具
qemu-nbd 磁盘挂载工具。

wget https://download.qemu.org/qemu-5.0.0.tar.xz
tar xvJf qemu-5.0.0.tar.xz
cd qemu-5.0.0/
./configure --target-list="x86_64-softmmu"
make
make install

https://libvirt.org/compiling.html

wget https://download.libvirt.org/libvirt-6.9.0.tar.xz
tar xvf libvirt-6.9.0.tar.xz
cd libvirt-6.9.0/ 
meson setup build

meson.build:443:27: ERROR: Expecting eol got id.
  if host_machine.system() in [ 'linux', 'freebsd', 'windows' ]


meson.build:919:2: ERROR: Program(s) ['xsltproc'] not found or not executable

yum install libxslt

meson.build:927:2: ERROR: Program(s) ['rpcgen', 'portable-rpcgen'] not found or not executable

yum search rpcgen

meson.build:1070:0: ERROR: Dependency "gnutls" not found, tried pkgconfig and cmake

yum install gnutls gnutls-devel gnutls-utils

meson.build:1166:0: ERROR: Dependency "libxml-2.0" not found, tried pkgconfig and cmake

yum install libxml2 libxml2-devel

meson.build:1534:4: ERROR: Problem encountered: XDR is required for remote driver

yum install libtirpc-devel

至此meson setup build成功

ninja -C build

ninja -C build install

////////////// QEMU-KVM: 安装第一个能上网的虚拟机

yum install bridge-utils


///////////


https://opendev.org/openstack/devstack

https://docs.openstack.org/devstack/zed/

 Ubuntu 20.04 (Focal Fossa)

 Ubuntu 18.04 (Bionic Beaver)

apt-get update
apt-get install git -y

git clone https://git.openstack.org/openstack-dev/devstack -b unmaintained/zed

git clone https://git.openstack.org/openstack-dev/devstack -b unmaintained/wallaby
不用OVN

devstack/tools/create-stack-user.sh

mv devstack /opt/stack

chown -R stack:stack /opt/stack/devstack

su – stack
cd devstack

alias pip='pip --default-timeout=3000'
alias pip3='pip3 --default-timeout=3000'

永久换源：
清华源
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

阿里源
pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/

腾讯源
pip config set global.index-url http://mirrors.cloud.tencent.com/pypi/simple

豆瓣源
pip config set global.index-url http://pypi.douban.com/simple/

3.换回默认源
pip config unset global.index-url

[global]
timeout = 60000
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
use-mirrors = true
mirrors = https://pypi.tuna.tsinghua.edu.cn

--default-timeout=1000 
-i https://pypi.tuna.tsinghua.edu.cn/simple

pip install tensorflow-gpu==2.1.0 --default-timeout=1000 -i http://pypi.mirrors.ustc.edu.cn/simple/ --trusted-host http://pypi.mirrors.ustc.edu.cn

解决国外源下载慢的问题，修改这个文件，发现修改pip.conf不管用
vim inc/python

# Wrapper for ``pip install`` to set cache and proxy environment variables
# Uses globals ``OFFLINE``, ``PIP_VIRTUAL_ENV``,
# ``PIP_UPGRADE``, ``*_proxy``,
# Usage:
#  pip_install pip_arguments
function pip_install {
    local xtrace result
    xtrace=$(set +o | grep xtrace)
    set +o xtrace
    local upgrade=""
    local offline=${OFFLINE:-False}
    if [[ "$offline" == "True" || -z "$@" ]]; then
        $xtrace
        return
    fi

    time_start "pip_install"

    PIP_UPGRADE=$(trueorfalse False PIP_UPGRADE)
    if [[ "$PIP_UPGRADE" = "True" ]] ; then
        upgrade="--upgrade"
    fi

    if [[ -z "$os_PACKAGE" ]]; then
        GetOSVersion
    fi

    # Try to extract the path of the package we are installing into
    # package_dir.  We need this to check for test-requirements.txt,
    # at least.
    #
    # ${!#} expands to the last positional argument to this function.
    # With "extras" syntax included, our arguments might be something
    # like:
    #  -e /path/to/fooproject[extra]
    # Thus this magic line grabs just the path without extras
    #
    # Note that this makes no sense if this is a pypi (rather than
    # local path) install; ergo you must check this path exists before
    # use.  Also, if we had multiple or mixed installs, we would also
    # likely break.  But for historical reasons, it's basically only
    # the other wrapper functions in here calling this to install
    # local packages, and they do so with single call per install.  So
    # this works (for now...)
    local package_dir=${!#%\[*\]}

    if [[ -n ${PIP_VIRTUAL_ENV:=} && -d ${PIP_VIRTUAL_ENV} ]]; then
        local cmd_pip=$PIP_VIRTUAL_ENV/bin/pip
        local sudo_pip="env"
    else
        local cmd_pip="python$PYTHON3_VERSION -m pip"
        # See
        #  https://github.com/pypa/setuptools/issues/2232
        #  http://lists.openstack.org/pipermail/openstack-discuss/2020-August/016905.html
        # this makes setuptools >=50 use the platform distutils.
        # We only want to do this on global pip installs, not if
        # installing in a virtualenv
        local sudo_pip="sudo -H LC_ALL=en_US.UTF-8 SETUPTOOLS_USE_DISTUTILS=stdlib "
        echo "Using python $PYTHON3_VERSION to install $package_dir"
    fi

    cmd_pip="$cmd_pip install"
    # Always apply constraints
    cmd_pip="$cmd_pip -c $REQUIREMENTS_DIR/upper-constraints.txt"

    $xtrace

    $sudo_pip \
        http_proxy="${http_proxy:-}" \
        https_proxy="${https_proxy:-}" \
        no_proxy="${no_proxy:-}" \
        PIP_FIND_LINKS=$PIP_FIND_LINKS \
        $cmd_pip $upgrade \
        $@ \
        -i https://pypi.tuna.tsinghua.edu.cn/simple \
        --default-timeout=30000
    result=$?

    time_stop "pip_install"
    return $result
}

# install_tempest() - Collect source and prepare
function install_tempest {
    git_clone $TEMPEST_REPO $TEMPEST_DIR $TEMPEST_BRANCH
    # NOTE(gmann): Pinning tox<4.0.0 for stable/zed and lower. Tox 4.0.0
    # released after zed was released and has some incompatible changes
    # and it is ok not to fix the issues caused by tox 4.0.0 in stable
    # beanches jobs. We can continue testing the stable/zed and lower
    # branches with tox<4.0.0
    pip_install 'tox!=2.8.0,<4.0.0'
    pushd $TEMPEST_DIR
    # NOTE(gmann): checkout the TEMPEST_BRANCH in case TEMPEST_BRANCH
    # is tag name not master. git_clone would not checkout tag because
    # TEMPEST_DIR already exist until RECLONE is true.
    git checkout $TEMPEST_BRANCH

    local tmp_u_c_m
    tmp_u_c_m=$(mktemp -t tempest_u_c_m.XXXXXXXXXX)
    set_tempest_venv_constraints $tmp_u_c_m

    tox -r --notest -efull
    # NOTE(mtreinish) Respect constraints in the tempest full venv, things that
    # are using a tox job other than full will not be respecting constraints but
    # running pip install -U on tempest requirements
    $TEMPEST_DIR/.tox/tempest/bin/pip install -c $tmp_u_c_m -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --default-timeout=30000
    PROJECT_VENV["tempest"]=${TEMPEST_DIR}/.tox/tempest
    rm -f $tmp_u_c_m
    popd
}

192.168.10.9(内)
121.229.204.157(公)

192.168.10.8(内)
121.229.204.156(公)

使用正确的分支
vim stackrc

# Set the target branch. This is used so that stable branching
# does not need to update each repo below.
TARGET_BRANCH=unmaintained/zed

WARNING neutron.plugins.ml2.drivers.ovn.mech_driver.mech_driver [None req-59871ae7-a47b-4e27-8eee-4d49162c758e None None] Firewall driver configuration is ignored
CRITICAL neutron.plugins.ml2.drivers.ovn.mech_driver.mech_driver [None req-59871ae7-a47b-4e27-8eee-4d49162c758e None None] Geneve max_header_size set too low for OVN (30 vs 38)

/etc/neutron/plugins/ml2/ml2_conf.ini

----------------
[ml2_type_geneve]
vni_ranges = 1:1000

#
# From neutron.ml2
#

# Comma-separated list of <vni_min>:<vni_max> tuples enumerating ranges of
# Geneve VNI IDs that are available for tenant network allocation. Note OVN
# does not use the actual values. (list value)
#vni_ranges =

# The maximum allowed Geneve encapsulation header size (in bytes). Geneve
# header is extensible, this value is used to calculate the maximum MTU for
# Geneve-based networks. The default is 30, which is the size of the Geneve
# header without any additional option headers. Note the default is not enough
# for OVN which requires at least 38. (integer value)
#max_header_size = 30
------------------

vim lib/neutron

    # NOTE(yamamoto): A decomposed plugin should prepare the config file in
    # its devstack plugin.
    if [ -f $NEUTRON_DIR/etc/neutron/plugins/$NEUTRON_CORE_PLUGIN/$NEUTRON_CORE_PLUGIN_CONF_FILENAME.sample ]; then
        cp $NEUTRON_DIR/etc/neutron/plugins/$NEUTRON_CORE_PLUGIN/$NEUTRON_CORE_PLUGIN_CONF_FILENAME.sample $NEUTRON_CORE_PLUGIN_CONF

        iniset $NEUTRON_CORE_PLUGIN_CONF ml2_type_geneve max_header_size 38
    fi


lib/neutron:NEUTRON_CORE_PLUGIN_CONF_FILENAME=${NEUTRON_CORE_PLUGIN_CONF_FILENAME:-ml2_conf.ini}


2024-05-08 03:36:41.328 | + lib/neutron-legacy:_configure_neutron_common:808 :   mkdir -p /etc/neutron/plugins/ml2
2024-05-08 03:36:41.330 | + lib/neutron-legacy:_configure_neutron_common:809 :   Q_PLUGIN_CONF_FILE=etc/neutron/plugins/ml2/ml2_conf.ini
2024-05-08 03:36:41.331 | + lib/neutron-legacy:_configure_neutron_common:812 :   '[' -f /opt/stack/neutron/etc/neutron/plugins/ml2/ml2_conf.ini.sample ']'
2024-05-08 03:36:41.332 | + lib/neutron-legacy:_configure_neutron_common:813 :   cp /opt/stack/neutron/etc/neutron/plugins/ml2/ml2_conf.ini.sample /etc/neutron/plugins/ml2/ml2_conf.ini

2024-05-08 03:36:42.320 | + lib/neutron_plugins/ml2:neutron_plugin_configure_service:122 :   iniset /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup firewall_driver neutron.agent.not.a.real.FirewallDriver
2024-05-08 03:36:42.336 | + lib/neutron_plugins/ml2:neutron_plugin_configure_service:127 :   populate_ml2_config /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers=ovn
2024-05-08 03:36:42.337 | + lib/neutron_plugins/ml2:populate_ml2_config:51 :   CONF=/etc/neutron/plugins/ml2/ml2_conf.ini
2024-05-08 03:36:42.344 | + lib/neutron_plugins/ml2:populate_ml2_config:60 :   iniset /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers ovn

opt/stack/neutron/devstack/ovn-compute-local.conf.sample:OVN_SB_REMOTE=tcp:$SERVICE_HOST:6642
opt/stack/neutron/devstack/ovn-local.conf.sample:#OVN_SB_REMOTE=tcp:$SERVICE_HOST:6642


Could not retrieve schema from tcp:127.0.0.1:6642

2024-05-08 06:35:25.914 | + ./stack.sh:main:1286                     :   is_service_enabled ovn-controller ovn-controller-vtep
2024-05-08 06:35:25.922 | + functions-common:is_service_enabled:2097 :   return 0
2024-05-08 06:35:25.924 | + ./stack.sh:main:1287                     :   echo_summary 'Starting OVN services'
2024-05-08 06:35:25.925 | + ./stack.sh:echo_summary:450              :   [[ -t 3 ]]
2024-05-08 06:35:25.926 | + ./stack.sh:echo_summary:450              :   [[ True != \T\r\u\e ]]
2024-05-08 06:35:25.927 | + ./stack.sh:echo_summary:456              :   echo -e Starting OVN services
2024-05-08 06:35:25.928 | + ./stack.sh:main:1288                     :   start_ovn_services
2024-05-08 06:35:25.930 | + lib/neutron-legacy:start_ovn_services:519 :   [[ openvswitch == \o\v\n ]]
2024-05-08 06:35:25.931 | + ./stack.sh:main:1291                     :   is_service_enabled neutron-api
2024-05-08 06:35:25.939 | + functions-common:is_service_enabled:2097 :   return 1
2024-05-08 06:35:25.940 | + ./stack.sh:main:1294                     :   is_service_enabled q-svc
2024-05-08 06:35:25.948 | + functions-common:is_service_enabled:2097 :   return 0
2024-05-08 06:35:25.949 | + ./stack.sh:main:1295                     :   echo_summary 'Starting Neutron'
2024-05-08 06:35:25.951 | + ./stack.sh:echo_summary:450              :   [[ -t 3 ]]
2024-05-08 06:35:25.952 | + ./stack.sh:echo_summary:450              :   [[ True != \T\r\u\e ]]
2024-05-08 06:35:25.953 | + ./stack.sh:echo_summary:456              :   echo -e Starting Neutron

https://opendev.org/openstack/devstack/src/branch/unmaintained/zed/stackrc

if ! isset ENABLED_SERVICES ; then
    # Keystone - nothing works without keystone
    ENABLED_SERVICES=key
    # Nova - services to support libvirt based openstack clouds
    ENABLED_SERVICES+=,n-api,n-cpu,n-cond,n-sch,n-novnc,n-api-meta
    # Placement service needed for Nova
    ENABLED_SERVICES+=,placement-api,placement-client
    # Glance services needed for Nova
    ENABLED_SERVICES+=,g-api
    # Cinder
    ENABLED_SERVICES+=,c-sch,c-api,c-vol
    # OVN
    ENABLED_SERVICES+=,ovn-controller,ovn-northd,ovs-vswitchd,ovsdb-server
    # Neutron
    ENABLED_SERVICES+=,q-svc,q-ovn-metadata-agent
    # Dashboard
    ENABLED_SERVICES+=,horizon
    # Additional services
    ENABLED_SERVICES+=,rabbit,tempest,mysql,etcd3,dstat
fi

在使用OVN之前

https://docs.openstack.org/devstack/wallaby/
Ubuntu 18.04 (Bionic Beaver)

if ! isset ENABLED_SERVICES ; then
    # Keystone - nothing works without keystone
    ENABLED_SERVICES=key
    # Nova - services to support libvirt based openstack clouds
    ENABLED_SERVICES+=,n-api,n-cpu,n-cond,n-sch,n-novnc,n-api-meta
    # Placement service needed for Nova
    ENABLED_SERVICES+=,placement-api,placement-client
    # Glance services needed for Nova
    ENABLED_SERVICES+=,g-api
    # Cinder
    ENABLED_SERVICES+=,c-sch,c-api,c-vol
    # Neutron
    ENABLED_SERVICES+=,q-svc,q-dhcp,q-meta,q-agt,q-l3
    # Dashboard
    ENABLED_SERVICES+=,horizon
    # Additional services
    ENABLED_SERVICES+=,rabbit,tempest,mysql,etcd3,dstat
fi


if is_service_enabled ovn-controller ovn-controller-vtep; then
    echo_summary "Starting OVN services"
    start_ovn_services
fi

# Start running OVN processes
function start_ovn_services {
    if [[ $Q_AGENT == "ovn" ]]; then
        init_ovn
        start_ovn
        if [[ "$OVN_L3_CREATE_PUBLIC_NETWORK" == "True" ]]; then
            if [[ "$NEUTRON_CREATE_INITIAL_NETWORKS" != "True" ]]; then
                echo "OVN_L3_CREATE_PUBLIC_NETWORK=True is being ignored "
                echo "because NEUTRON_CREATE_INITIAL_NETWORKS is set to False"
            else
                create_public_bridge
            fi
        fi
    fi
}

function init_ovn {
    # clean up from previous (possibly aborted) runs
    # create required data files

    # Assumption: this is a dedicated test system and there is nothing important
    # in the ovn, ovn-nb, or ovs databases.  We're going to trash them and
    # create new ones on each devstack run.

    _disable_libvirt_apparmor
    local mkdir_cmd="mkdir -p ${OVN_DATADIR}"

    if [[ "$OVN_BUILD_FROM_SOURCE" == "False" ]]; then
        mkdir_cmd="sudo ${mkdir_cmd}"
    fi

    $mkdir_cmd
    mkdir -p $OVS_DATADIR

    rm -f $OVS_DATADIR/*.db
    rm -f $OVS_DATADIR/.*.db.~lock~
    sudo rm -f $OVN_DATADIR/*.db
    sudo rm -f $OVN_DATADIR/.*.db.~lock~
    sudo rm -f $OVN_RUNDIR/*.sock
}



Installing collected packages: argparse, httplib2, cursive, glance
  Attempting uninstall: httplib2
    Found existing installation: httplib2 0.9.2
ERROR: Cannot uninstall 'httplib2'. It is a distutils installed project and thus we cannot accurately determine which files belong to it which would lead to only a partial uninstall.
+ inc/python:pip_install:1                 :   exit_trap
+ ./stack.sh:exit_trap:524                 :   local r=1
++ ./stack.sh:exit_trap:525                 :   jobs -p
+ ./stack.sh:exit_trap:525                 :   jobs=
+ ./stack.sh:exit_trap:528                 :   [[ -n '' ]]
+ ./stack.sh:exit_trap:534                 :   '[' -f '' ']'
+ ./stack.sh:exit_trap:539                 :   kill_spinner
+ ./stack.sh:kill_spinner:434              :   '[' '!' -z '' ']'
+ ./stack.sh:exit_trap:541                 :   [[ 1 -ne 0 ]]
+ ./stack.sh:exit_trap:542                 :   echo 'Error on exit'
Error on exit
+ ./stack.sh:exit_trap:544                 :   type -p generate-subunit
+ ./stack.sh:exit_trap:545                 :   generate-subunit 1715165724 46 fail
+ ./stack.sh:exit_trap:547                 :   [[ -z /opt/stack/logs ]]
+ ./stack.sh:exit_trap:550                 :   /usr/bin/python3.6 /opt/stack/devstack/tools/worlddump.py -d /opt/stack/logs
+ ./stack.sh:exit_trap:559                 :   exit 1

pip install --ignore-installed httplib2


stack@devstack-controller:~/devstack$ pip show httplib2
Name: httplib2
Version: 0.22.0
Summary: A comprehensive HTTP client library.
Home-page: https://github.com/httplib2/httplib2
Author: Joe Gregorio
Author-email: joe@bitworking.org
License: MIT
Location: /opt/stack/.local/lib/python3.6/site-packages
Requires: pyparsing
Required-by:
stack@devstack-controller:~/devstack$ pip3
pip3    pip3.6
stack@devstack-controller:~/devstack$ pip3 show httplib2
Name: httplib2
Version: 0.22.0
Summary: A comprehensive HTTP client library.
Home-page: https://github.com/httplib2/httplib2
Author: Joe Gregorio
Author-email: joe@bitworking.org
License: MIT
Location: /opt/stack/.local/lib/python3.6/site-packages
Requires: pyparsing
Required-by:

cd /usr/lib/python3/dist-packages/
里面有httplib2 0.9.2
删除

++ lib/tempest:install_tempest:766          :   tox -r --notest -efull
full create: /opt/stack/tempest/.tox/tempest
full installdeps: -c/opt/stack/requirements/upper-constraints.txt, -r/opt/stack/tempest/requirements.txt

/opt/stack/tempest/.tox/tempest/bin/pip install -c/opt/stack/requirements/upper-constraints.txt -r/opt/stack/tempest/requirements.txt

tox -i https://pypi.my-alternative-index.org

tox -r --notest -efull -i https://pypi.tuna.tsinghua.edu.cn/simple

# install_tempest() - Collect source and prepare
function install_tempest {
    git_clone $TEMPEST_REPO $TEMPEST_DIR $TEMPEST_BRANCH
    # NOTE(gmann): Pinning tox<4.0.0 for stable/zed and lower. Tox 4.0.0
    # released after zed was released and has some incompatible changes
    # and it is ok not to fix the issues caused by tox 4.0.0 in stable
    # beanches jobs. We can continue testing the stable/zed and lower
    # branches with tox<4.0.0
    pip_install 'tox!=2.8.0,<4.0.0'
    pushd $TEMPEST_DIR
    # NOTE(gmann): checkout the TEMPEST_BRANCH in case TEMPEST_BRANCH
    # is tag name not master. git_clone would not checkout tag because
    # TEMPEST_DIR already exist until RECLONE is true.
    git checkout $TEMPEST_BRANCH

    local tmp_u_c_m
    tmp_u_c_m=$(mktemp -t tempest_u_c_m.XXXXXXXXXX)
    set_tempest_venv_constraints $tmp_u_c_m

    tox -r --notest -efull -i https://pypi.tuna.tsinghua.edu.cn/simple
    # NOTE(mtreinish) Respect constraints in the tempest full venv, things that
    # are using a tox job other than full will not be respecting constraints but
    # running pip install -U on tempest requirements
    $TEMPEST_DIR/.tox/tempest/bin/pip install -c $tmp_u_c_m -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
    PROJECT_VENV["tempest"]=${TEMPEST_DIR}/.tox/tempest
    rm -f $tmp_u_c_m
    popd
}


+ ./stack.sh:main:1430                     :   is_nova_ready
+ lib/nova:is_nova_ready:1072              :   wait_for_compute 60
+ functions:wait_for_compute:471           :   local timeout=60
+ functions:wait_for_compute:472           :   local rval=0
+ functions:wait_for_compute:473           :   local compute_hostname
+ functions:wait_for_compute:474           :   time_start wait_for_service
+ functions-common:time_start:2323         :   local name=wait_for_service
+ functions-common:time_start:2324         :   local start_time=
+ functions-common:time_start:2325         :   [[ -n '' ]]
++ functions-common:time_start:2328         :   date +%s%3N
+ functions-common:time_start:2328         :   _TIME_START[$name]=1715218069184
++ functions:wait_for_compute:475           :   iniget /etc/nova/nova.conf DEFAULT host
+ functions:wait_for_compute:475           :   compute_hostname=
+ functions:wait_for_compute:476           :   [[ -z '' ]]
++ functions:wait_for_compute:477           :   hostname
+ functions:wait_for_compute:477           :   compute_hostname=devstack-controller
+ functions:wait_for_compute:479           :   timeout 60 bash -x
++ functions:wait_for_compute:479           :   hostname
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ ::                                       :   [[ libvirt = \f\a\k\e ]]
++ ::                                       :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+ ::                                       :   ID=
+ ::                                       :   [[ '' == '' ]]
+ ::                                       :   sleep 1
+ functions:wait_for_compute:479           :   rval=124
+ functions:wait_for_compute:491           :   time_stop wait_for_service
+ functions-common:time_stop:2337          :   local name
+ functions-common:time_stop:2338          :   local end_time
+ functions-common:time_stop:2339          :   local elapsed_time
+ functions-common:time_stop:2340          :   local total
+ functions-common:time_stop:2341          :   local start_time
+ functions-common:time_stop:2343          :   name=wait_for_service
+ functions-common:time_stop:2344          :   start_time=1715218069184
+ functions-common:time_stop:2346          :   [[ -z 1715218069184 ]]
++ functions-common:time_stop:2349          :   date +%s%3N
+ functions-common:time_stop:2349          :   end_time=1715218129219
+ functions-common:time_stop:2350          :   elapsed_time=60035
+ functions-common:time_stop:2351          :   total=9336
+ functions-common:time_stop:2353          :   _TIME_START[$name]=
+ functions-common:time_stop:2354          :   _TIME_TOTAL[$name]=69371
+ functions:wait_for_compute:493           :   [[ 124 != 0 ]]
+ functions:wait_for_compute:494           :   echo 'Didn'\''t find service registered by hostname after 60 seconds'
Didn't find service registered by hostname after 60 seconds
+ functions:wait_for_compute:495           :   openstack --os-cloud devstack-admin --os-region RegionOne compute service list
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
+----+----------------+---------------------+----------+---------+-------+----------------------------+
| ID | Binary         | Host                | Zone     | Status  | State | Updated At                 |
+----+----------------+---------------------+----------+---------+-------+----------------------------+
|  2 | nova-scheduler | devstack-controller | internal | enabled | up    | 2024-05-09T01:28:44.000000 |
|  5 | nova-conductor | devstack-controller | internal | enabled | up    | 2024-05-09T01:28:46.000000 |
|  1 | nova-conductor | devstack-controller | internal | enabled | up    | 2024-05-09T01:28:47.000000 |
+----+----------------+---------------------+----------+---------+-------+----------------------------+
+ functions:wait_for_compute:497           :   return 124
+ lib/nova:is_nova_ready:1                 :   exit_trap
+ ./stack.sh:exit_trap:524                 :   local r=124
++ ./stack.sh:exit_trap:525                 :   jobs -p
+ ./stack.sh:exit_trap:525                 :   jobs=
+ ./stack.sh:exit_trap:528                 :   [[ -n '' ]]
+ ./stack.sh:exit_trap:534                 :   '[' -f /tmp/tmp.mI7Z4X1BLb ']'
+ ./stack.sh:exit_trap:535                 :   rm /tmp/tmp.mI7Z4X1BLb
+ ./stack.sh:exit_trap:539                 :   kill_spinner
+ ./stack.sh:kill_spinner:434              :   '[' '!' -z '' ']'
+ ./stack.sh:exit_trap:541                 :   [[ 124 -ne 0 ]]
+ ./stack.sh:exit_trap:542                 :   echo 'Error on exit'
Error on exit
+ ./stack.sh:exit_trap:544                 :   type -p generate-subunit
+ ./stack.sh:exit_trap:545                 :   generate-subunit 1715217651 479 fail
+ ./stack.sh:exit_trap:547                 :   [[ -z /opt/stack/logs ]]
+ ./stack.sh:exit_trap:550                 :   /usr/bin/python3.6 /opt/stack/devstack/tools/worlddump.py -d /opt/stack/logs
neutron-dhcp-agent: no process found
neutron-l3-agent: no process found
neutron-metadata-agent: no process found
neutron-openvswitch-agent: no process found
stack@devstack-controller:~/devstack$ + ./stack.sh:exit_trap:559                 :   exit 124

上面是检查nova-compute是否运行，发现没有运行

ERROR nova.virt.libvirt.host [-] Connection to libvirt failed: Failed to connect socket to '/var/run/libvirt/libvirt-sock': Permission denied: libvirt.libvirtError: Failed to connect socket to '/var/run/libvirt/libvirt-sock': Permission denied

error: Failed to connect socket to '/var/run/libvirt/libvirt-sock': Permission denied
error: failed to connect to the hypervisor
（当前用户没有权限，修改/etc/libvirt/libvirtd.conf,unix_sock_rw_perms = 0777,使所有用户都有权限读写）

报错信息：error: Failed to connect socket to ‘/var/run/libvirt/libvirt-sock’: Permission denied 处理方法： 修改libvirt配置文件：/etc/libvirt/libvirtd.conf 将unix_sock_rw_perms = 0770 修改为unix_sock_rw_perms = 0777 即可

ERROR oslo_service.service [-] Error starting thread.: nova.exception.InternalError: Nova requires libvirt version 6.0.0 or greater.

在18.04以及之前版本，安装libvirt，只需要安装libvirt-bin

$ sudo apt install libvirt-bin
但是在18.10，libvirt-bin已经被拆分成两部分libvirt-daemon-system和libvirt-clients

$ sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils



+ lib/nova_plugins/functions-libvirt:configure_libvirt:158 :   sudo tee -a /etc/libvirt/libvirtd.conf


wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-clients_6.0.0-0ubuntu8_amd64.deb
wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon_6.0.0-0ubuntu8_amd64.deb
wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon-driver-qemu_6.0.0-0ubuntu8_amd64.deb
wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon-driver-storage-rbd_6.0.0-0ubuntu8_amd64.deb
wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon-system_6.0.0-0ubuntu8_amd64.deb
wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon-system-systemd_6.0.0-0ubuntu8_amd64.deb



 libvirt-clients : Depends: libgcc-s1 (>= 3.3.1) but it is not installable
                   Depends: libreadline8 (>= 6.0) but it is not installable
                   Depends: libvirt0 (= 6.0.0-0ubuntu8) but 4.0.0-1ubuntu8.21 is to be installed
 libvirt-daemon : Depends: libcap-ng0 (>= 0.7.9) but 0.7.7-3.1 is to be installed
                  Depends: libgcc-s1 (>= 3.3.1) but it is not installable
                  Depends: libvirt0 (= 6.0.0-0ubuntu8) but 4.0.0-1ubuntu8.21 is to be installed
 libvirt-daemon-driver-qemu : Depends: libgcc-s1 (>= 3.3.1) but it is not installable
                              Depends: libgnutls30 (>= 3.6.12) but 3.5.18-1ubuntu1.6 is to be installed
                              Depends: libvirt0 (>= 6.0.0-0ubuntu8) but 4.0.0-1ubuntu8.21 is to be installed
 libvirt-daemon-driver-storage-rbd : Depends: libgcc-s1 (>= 3.3.1) but it is not installable
                                     Depends: librados2 (>= 14.2.0) but 12.2.13-0ubuntu0.18.04.11 is to be installed
                                     Depends: librbd1 (>= 14.2.0) but 12.2.13-0ubuntu0.18.04.11 is to be installed
                                     Depends: libvirt0 (>= 6.0.0-0ubuntu8) but 4.0.0-1ubuntu8.21 is to be installed
 libvirt-daemon-system : Depends: libgcc-s1 (>= 3.3.1) but it is not installable
                         Depends: libvirt0 (>= 6.0.0-0ubuntu8) but 4.0.0-1ubuntu8.21 is to be installed
                         Depends: iptables (>= 1.8.1-1) but 1.6.1-2ubuntu2.1 is to be installed or
                                  firewalld but it is not going to be installed

Traceback (most recent call last):
  File "/usr/local/bin/rst2html5", line 5, in <module>
    from rst2html5_ import main
  File "/usr/local/lib/python3.6/dist-packages/rst2html5_.py", line 17, in <module>
    from rst2html5 import HTML5Writer  # noqa E402
  File "/usr/local/lib/python3.6/dist-packages/rst2html5/__init__.py", line 4, in <module>
    from importlib import metadata
ImportError: cannot import name 'metadata'
Makefile:1474: recipe for target 'libvirt-go.html.in' failed
make[2]: *** [libvirt-go.html.in] Error 1

make[2]: Entering directory '/root/libvirt-6.1.0/build/docs'
  GEN      libvirt-go.html.in
  GEN      libvirt-go.html.tmp
libvirt-go.html.in:320: namespace error : Failed to parse QName 'http:'
  /* optimum is 45…75 characters/line <http://webtypography.net/2.1.2> */
                                              ^
libvirt-go.html.in:320: parser error : error parsing attribute name
  /* optimum is 45…75 characters/line <http://webtypography.net/2.1.2> */
                                              ^
libvirt-go.html.in:320: parser error : attributes construct error
  /* optimum is 45…75 characters/line <http://webtypography.net/2.1.2> */
                                              ^
libvirt-go.html.in:320: parser error : Couldn't find end of Start Tag http: line 320
  /* optimum is 45…75 characters/line <http://webtypography.net/2.1.2> */



rm -rf docs/

root@devstack-controller:~/libvirt-6.1.0/build# history
    1  ls
    2  apt-get update
    3  apt-get install git -y
    4  ps aux | grep ovs
    5  ls
    6  git clone https://git.openstack.org/openstack-dev/devstack -b unmaintained/wallaby
    7  ls
    8  devstack/tools/create-stack-user.sh
    9  ls
   10  mv devstack /opt/stack
   11  ls
   12  cd /opt/stack/
   13  ls
   14  chown -R stack:stack /opt/stack/devstack
   15  su - stack
   16  cd cd /usr/lib/python3/dist-packages/
   17  cd /usr/lib/python3/dist-packages/
   18  ls
   19  rm -rf httplib2*
   20  ls
   21  cd ~
   22  ls
   23  su - stack
   24  vim /etc/libvirt/libvirtd.conf
   25  su - stack
   26  ls
   27  cd ~
   28  ls
   29  wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-clients_6.0.0-0ubuntu8_amd64.deb
   30  wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon_6.0.0-0ubuntu8_amd64.deb
   31  wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon-driver-qemu_6.0.0-0ubuntu8_amd64.deb
   32  wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon-driver-storage-rbd_6.0.0-0ubuntu8_amd64.deb
   33  wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon-system_6.0.0-0ubuntu8_amd64.deb
   34  wget http://archive.ubuntu.com/ubuntu/pool/main/libv/libvirt/libvirt-daemon-system-systemd_6.0.0-0ubuntu8_amd64.deb
   35  ls
   36  dpkg -i libvirt-*
   37  ls
   38  rm -rf *
   39  ls
   40  wget wget https://download.libvirt.org/libvirt-6.9.0.tar.xz
   41  tar xvf libvirt-6.9.0.tar.xz
   42  ls
   43  cd libvirt-6.9.0/
   44  ls
   45  apt-get install meson
   46  apt --fix-broken install
   47  apt-get install meson
   48  ls
   49  meson setup build
   50  meson build
   51  meson --version
   52  apt-get install meson
   53  cd ..
   54  ls
   55  wget https://download.libvirt.org/libvirt-6.1.0.tar.xz
   56  history
   57  ls
   58  tar xvf libvirt-6.1.0.tar.xz
   59  ls
   60  cd libvirt-6.1.0/
   61  ls
   62  meson setup build
   63  ./configure
   64  ls
   65  ./configure
   66  mkdir build
   67  ls
   68  cd build
   69  ls
   70  ../configure
   71  apt-get install gnutls
   72  apt-get search gnutls
   73  apt-cache search gnutls
   74  apt-get install gnutls-bin
   75  ../configure
   76  apt-cache search gnutls
   77*
   78  ../configure
   79  dpkg -i gnutls
   80  dpkg -l gnutls
   81  dpkg -l | grep gnutls
   82  apt-cache search gnutls
   83  apt-get install libgnutls-dane0 libgnutls-openssl27 libgnutls28-dev libgnutls30 libgnutlsxx28
   84  ls
   85  ../configure
   86  apt-get install  libnl3-devel
   87  apt-cache search  libnl3-devel
   88  apt-cache search  libnl3
   89  apt-get install libnl-3-dev
   90  ../configure
   91  apt-cache search libnl-route
   92  apt-get install libnl-route-3-dev
   93  ../configure
   94  apt-cache search xsltproc
   95  apt-get install xsltproc
   96  ../configure
   97  apt-cache search rst2html
   98  apt-cache search rst2
   99  apt-cache search rst
  100  apt-cache search rst2html
  101  pip install rst2html
  102  pip install rst2html5
  103  ../configure
  104  apt-cache search device-mapper
  105  apt-get install libdevmapper-dev libdevmapper1.02.1
  106  ../configure
  107  apt-cache search pciaccess
  108  apt-get install libpciaccess-dev libpciaccess0
  109  ../configure
  110  make
  111  pip unstall rst2html5
  112  pip -h
  113  pip uninstall rst2html5
  114  ../configure
  115  make
  116  ../configure -h
  117  ../configure -h | grep docs
  118  ls
  119  cd ..
  120  ls
  121  grep -r "docs"
  122  ls
  123  cd docs/
  124  ls
  125  cd ..
  126  ls
  127  rm -rf docs/
  128  ls
  129  cd build
  130  ls
  131  ../configure
  132  cd ..
  133  ls
  134  grep -r "docs"
  135  vim configure
  136  ls
  137  cd build
  138  ls
  139  ../configure
  140  make
  141  ls
  142  rm docs/
  143  rm -r docs/
  144  ls
  145  cd ..
  146  ls
  147  grep -r "docs"
  148  vim configure.ac
  149  vim Makefile.am
  150  grep -r "docs"
  151  ls
  152  cd ..
  153  ls
  154  mv libvirt-6.1.0 libvirt-6.1.0.back
  155  ls
  156  tar xvf libvirt-6.1.0.tar.xz
  157  ls
  158  cd libvirt-6.1.0
  159  ls
  160  grep -r "docs"
  161  ls
  162  rm -rf docs/
  163  ls
  164  grep -r "docs"
  165  vim configure
  166  ls
  167  cd ..
  168  ls
  169  rm -rf libvirt-6.1.0
  170  ls
  171  tar xvf libvirt-6.1.0.tar.xz
  172  ls
  173  cd libvirt-6.1.0
  174  ls
  175  cd docs/
  176  ls
  177  vim Makefile.am
  178  mv Makefile.am Makefile.am.back
  179  vim Makefile.am
  180  vim Makefile.in
  181  mv Makefile.in Makefile.in.back
  182  ls
  183  cd ..
  184  ls
  185  mkdir build
  186  cd build
  187  ls
  188  ../configure
  189  ls
  190  cd ..
  191  ls
  192  cd docs/
  193  ls
  194  touch Makefile.in
  195  ls
  196  cd ..
  197  cd build
  198  ls
  199  ../configure
  200  make
  201  ls
  202  cd docs/
  203  ls
  204  cat Makefile
  205  cd ..
  206  ls
  207  cd docs/
  208  ls
  209  cd ..
  210  ls
  211  cd docs/
  212  ls
  213  cat Makefile
  214  ls
  215  cat Makefile.am
  216  vim Makefile.in.back
  217  vim Makefile.in
  218  ls
  219  cd ..
  220  ls
  221  cd build
  222  ls
  223  cd ..
  224  ls
  225  rm -rf build
  226  ls
  227  mkdir build
  228  cd build
  229  ls
  230  ../configure
  231  ls
  232  cd docs/
  233  ls
  234  cat Makefile
  235  ls
  236  cd ..
  237  ls
  238  make
  239  make install
  240  ls
  241  cd ..
  242  ls
  243  cd docs/
  244  ls
  245  vim Makefile.in.back
  246  vim Makefile.in
  247  cd ..
  248  ls
  249  cd build
  250  ls
  251  ../configure
  252  ls
  253  make
  254  make install
  255  ls
  256  cd ..
  257  systemctl restart libvirtd.service
  258  virsh --version
  259  apt-get remove libvirt-bin
  260  dpkg -l | grep libvirt
  261  apt-get remove  libvirt-bin
  262  dpkg -r libvirt-bin
  263  dpkg -h
  264  dpkg --help
  265  dpkg -l | grep libvirt
  266  dpkg -r libvirt-bin
  267  apt-get purge libvirt-bin
  268  dpkg -l | grep libvirt
  269  apt-get purge  libvirt-dev:amd64
  270  apt-get purge libvirt0:amd64
  271  apt-get purge python3-libvirt
  272  dpkg -l | grep libvirt
  273  apt-get purge libvirt-clients
  274  apt-get purge libvirt-daemon-system
  275  apt-get purge libvirt-daemon-system-systemd
  276  dpkg -l | grep libvirt
  277  apt-get install libvirt-bin
  278  cat /usr/local/lib/systemd/system/libvirtd.service
  279  apt-get purge libvirt-bin
  280  dpkg -l | grep libvirt
  281  apt-get purge libvirt0:amd64 libvirt-daemon-system libvirt-daemon-driver-storage-rbd libvirt-daemon libvirt-clients libvirt-bin
  282  dpkg -l | grep libvirt
  283  ls
  284  cd build
  285  ls
  286  make install
  287  virsh
  288  virsh --version
  289  history

root@devstack-controller:~/libvirt-6.1.0/docs# cat Makefile.
Makefile.am       Makefile.am.back  Makefile.in       Makefile.in.back
root@devstack-controller:~/libvirt-6.1.0/docs# cat Makefile.am
all:
        echo "helloworld"
root@devstack-controller:~/libvirt-6.1.0/docs# cat Makefile.in
all:
        echo "hello world 1"
install:
        echo "hello world 2"


root@devstack-controller:~/libvirt-6.1.0# cat /usr/local/lib/systemd/system/libvirtd.service
[Unit]
Description=Virtualization daemon
Requires=virtlogd.socket
Requires=virtlockd.socket
# Use Wants instead of Requires so that users
# can disable these three .socket units to revert
# to a traditional non-activation deployment setup
Wants=libvirtd.socket
Wants=libvirtd-ro.socket
Wants=libvirtd-admin.socket
Wants=systemd-machined.service
Before=libvirt-guests.service
After=network.target
After=dbus.service
After=iscsid.service
After=apparmor.service
After=local-fs.target
After=remote-fs.target
After=systemd-logind.service
After=systemd-machined.service
After=xencommons.service
Conflicts=xendomains.service
Documentation=man:libvirtd(8)
Documentation=https://libvirt.org

[Service]
Type=notify
EnvironmentFile=-/usr/local/etc/sysconfig/libvirtd
ExecStart=/usr/local/sbin/libvirtd $LIBVIRTD_ARGS
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
# At least 1 FD per guest, often 2 (eg qemu monitor + qemu agent).
# eg if we want to support 4096 guests, we'll typically need 8192 FDs
# If changing this, also consider virtlogd.service & virtlockd.service
# limits which are also related to number of guests
LimitNOFILE=8192
# The cgroups pids controller can limit the number of tasks started by
# the daemon, which can limit the number of domains for some hypervisors.
# A conservative default of 8 tasks per guest results in a TasksMax of
# 32k to support 4096 guests.
TasksMax=32768
# With cgroups v2 there is no devices controller anymore, we have to use
# eBPF to control access to devices.  In order to do that we create a eBPF
# hash MAP which locks memory.  The default map size for 64 devices together
# with program takes 12k per guest.  After rounding up we will get 64M to
# support 4096 guests.
LimitMEMLOCK=64M

[Install]
WantedBy=multi-user.target
Also=virtlockd.socket
Also=virtlogd.socket
Also=libvirtd.socket
Also=libvirtd-ro.socket


https://www.cnblogs.com/ck1020/p/6024039.html

root@devstack-controller:/usr/local/lib/systemd/system# ls -l
total 228
-rw-r--r-- 1 root root  381 May  9 17:42 libvirtd-admin.socket
-rw-r--r-- 1 root root  388 May  9 17:42 libvirtd-ro.socket
-rw-r--r-- 1 root root 1880 May  9 17:42 libvirtd.service
-rw-r--r-- 1 root root  329 May  9 17:42 libvirtd.socket
-rw-r--r-- 1 root root  316 May  9 17:42 libvirtd-tcp.socket
-rw-r--r-- 1 root root  312 May  9 17:42 libvirtd-tls.socket
-rw-r--r-- 1 root root  639 May  9 17:43 libvirt-guests.service
drwxr-xr-x 2 root root 4096 May  9 17:42 old
-rw-r--r-- 1 root root   77 May  9 17:42 virt-guest-shutdown.target
-rw-r--r-- 1 root root  534 May  9 17:42 virtinterfaced-admin.socket
-rw-r--r-- 1 root root  541 May  9 17:42 virtinterfaced-ro.socket
-rw-r--r-- 1 root root  589 May  9 17:42 virtinterfaced.service
-rw-r--r-- 1 root root  470 May  9 17:42 virtinterfaced.socket
-rw-r--r-- 1 root root  281 May  9 17:42 virtlockd-admin.socket
-rw-r--r-- 1 root root  711 May  9 17:42 virtlockd.service
-rw-r--r-- 1 root root  195 May  9 17:42 virtlockd.socket
-rw-r--r-- 1 root root  270 May  9 17:42 virtlogd-admin.socket
-rw-r--r-- 1 root root  844 May  9 17:42 virtlogd.service
-rw-r--r-- 1 root root  193 May  9 17:42 virtlogd.socket
-rw-r--r-- 1 root root  492 May  9 17:42 virtlxcd-admin.socket
-rw-r--r-- 1 root root  499 May  9 17:42 virtlxcd-ro.socket
-rw-r--r-- 1 root root 1579 May  9 17:42 virtlxcd.service
-rw-r--r-- 1 root root  440 May  9 17:42 virtlxcd.socket
-rw-r--r-- 1 root root  520 May  9 17:42 virtnetworkd-admin.socket
-rw-r--r-- 1 root root  527 May  9 17:42 virtnetworkd-ro.socket
-rw-r--r-- 1 root root  590 May  9 17:42 virtnetworkd.service
-rw-r--r-- 1 root root  460 May  9 17:42 virtnetworkd.socket
-rw-r--r-- 1 root root  520 May  9 17:42 virtnodedevd-admin.socket
-rw-r--r-- 1 root root  527 May  9 17:42 virtnodedevd-ro.socket
-rw-r--r-- 1 root root  573 May  9 17:42 virtnodedevd.service
-rw-r--r-- 1 root root  460 May  9 17:42 virtnodedevd.socket
-rw-r--r-- 1 root root  527 May  9 17:42 virtnwfilterd-admin.socket
-rw-r--r-- 1 root root  534 May  9 17:42 virtnwfilterd-ro.socket
-rw-r--r-- 1 root root  581 May  9 17:42 virtnwfilterd.service
-rw-r--r-- 1 root root  465 May  9 17:42 virtnwfilterd.socket
-rw-r--r-- 1 root root  503 May  9 17:42 virtproxyd-admin.socket
-rw-r--r-- 1 root root  510 May  9 17:42 virtproxyd-ro.socket
-rw-r--r-- 1 root root  551 May  9 17:42 virtproxyd.service
-rw-r--r-- 1 root root  447 May  9 17:42 virtproxyd.socket
-rw-r--r-- 1 root root  438 May  9 17:42 virtproxyd-tcp.socket
-rw-r--r-- 1 root root  434 May  9 17:42 virtproxyd-tls.socket
-rw-r--r-- 1 root root  513 May  9 17:42 virtsecretd-admin.socket
-rw-r--r-- 1 root root  520 May  9 17:42 virtsecretd-ro.socket
-rw-r--r-- 1 root root  565 May  9 17:42 virtsecretd.service
-rw-r--r-- 1 root root  455 May  9 17:42 virtsecretd.socket
-rw-r--r-- 1 root root  520 May  9 17:42 virtstoraged-admin.socket
-rw-r--r-- 1 root root  527 May  9 17:42 virtstoraged-ro.socket
-rw-r--r-- 1 root root  617 May  9 17:42 virtstoraged.service
-rw-r--r-- 1 root root  460 May  9 17:42 virtstoraged.socket
-rw-r--r-- 1 root root  499 May  9 17:42 virtvboxd-admin.socket
-rw-r--r-- 1 root root  506 May  9 17:42 virtvboxd-ro.socket
-rw-r--r-- 1 root root  572 May  9 17:42 virtvboxd.service
-rw-r--r-- 1 root root  445 May  9 17:42 virtvboxd.socket
-rw-r--r-- 1 root root  537 May  9 17:42 virtxend-admin.socket
-rw-r--r-- 1 root root  544 May  9 17:42 virtxend-ro.socket
-rw-r--r-- 1 root root  678 May  9 17:42 virtxend.service
-rw-r--r-- 1 root root  485 May  9 17:42 virtxend.socket

不用自己创建systemd文件，libvirt的make install会自动创建


  303  systemctl daemon-reload
  304  systemctl restart libvirtd.service
  305  systemctl status libvirtd.service


在su - stack里面的history

stack@devstack-controller:~/devstack$ history
    1  ls
    2  cd devstack/
    3  ls
    4  vim inc/python
    5  vim stackrc
    6  ls
    7  ./stack.sh
    8  ls
    9  vim local.conf
   10  ./stack.sh
   11  rm /opt/stack/devstack/files/etcd-v3.3.12-linux-amd64.tar.gz
   12  cd /opt/stack/devstack/files/
   13  ls
   14  pwd
   15  wget https://github.com/etcd-io/etcd/releases/download/v3.3.12/etcd-v3.3.12-linux-amd64.tar.gz
   16  ls
   17  rm etcd-v3.3.12-linux-amd64.tar.gz
   18  ls
   19  mv /opt/stack/etcd-v3.3.12-linux-amd64.tar.gz ./
   20  ls
   21  rm etcd.sha256sum
   22  ls
   23  cd ~
   24  ls
   25  cd devstack/
   26  ls
   27  ./stack.sh
   28  pip install httplib2
   29  ./stack.sh
   30  pip uninstall httplib2
   31  pip uninstall httplib2 --force
   32  pip install --ignore-installed httplib2
   33  ./stack.sh
   34  pip show pip install --ignore-installed httplib2
   35  pip show httplib2
   36  pip3 show httplib2
   37  cd /usr/local/lib/python3.6/dist-packages
   38  ls
   39  ls -l | grep http
   40  cd /opt/stack/.local/
   41  ls
   42  cd lib/
   43  ls
   44  cd python3.6/
   45  ls
   46  cd site-packages/
   47  ls
   48  cd httplib2
   49  ls
   50  cd ..
   51  ls
   52  cd /
   53  ls
   54  find -name "httplib2"
   55  cd /usr/lib/python3/dist-packages/
   56  ls
   57  rm httplib2*
   58  exit
   59  ls
   60  cd devstack/
   61  ls
   62  ./stack.sh
   63  pip install netaddr
   64  ./stack.sh
   65  ls
   66  vim inc/python
   67  pip install oslo.serialization
   68  ./stack.sh
   69  pip install fixtures
   70  pip install PyYAML
   71  ./stack.sh
   72  pip install PyYAML==5.4.1
   73  tox -r --notest -efull
   74  /opt/stack/tempest/.tox/tempest/bin/pip -c/opt/stack/requirements/upper-constraints.txt, -r/opt/stack/tempest/requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --default-timeout=30000
   75  /opt/stack/tempest/.tox/tempest/bin/pip install -c/opt/stack/requirements/upper-constraints.txt, -r/opt/stack/tempest/requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --default-timeout=30000
   76  /opt/stack/tempest/.tox/tempest/bin/pip install -c /opt/stack/requirements/upper-constraints.txt, -r/opt/stack/tempest/requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --default-timeout=30000
   77  /opt/stack/tempest/.tox/tempest/bin/pip install -c /opt/stack/requirements/upper-constraints.txt -r /opt/stack/tempest/requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --default-timeout=30000
   78  vim lib/tempest
   79  ./stack.sh
   80  vim lib/tempest
   81  pip install setuptools==54.1.1
   82  ./stack.sh
   83  cd ..
   84  ls
   85  grep -r "full installdeps"
   86  vim /opt/stack/tempest/.tox/tempest/log/full-1.log
   87  /opt/stack/tempest/.tox/tempest/bin/pip install -c/opt/stack/requirements/upper-constraints.txt -r/opt/stack/tempest/requirements.txt
   88  cd /opt/stack/tempest/.tox/
   89  ls
   90  cd log/
   91  ls
   92  cd ..
   93  ls
   94  cd tempest/
   95  ls
   96  cat pyvenv.cfg
   97  ls
   98  cd bin/
   99  ls
  100  cd .
  101  cd ..
  102  ls
  103  cd lib/
  104  ls
  105  cd ..
  106  cd
  107  cd devstack/
  108  ls
  109  ./stack.sh
  110  vim lib/tempest
  111  ./stack.sh
  112  vim lib/tempest
  113  ./stack.sh
  114  cd /opt/stack/devstack/files/
  115  ls
  116  rm cirros-0.5.2-x86_64-disk.img
  117  wget --progress=dot:giga -c http://download.cirros-cloud.net/0.5.2/cirros-0.5.2-x86_64-disk.img -O /opt/stack/devstack/files/cirros-0.5.2-x86_64-disk.img
  118  ls
  119  rm cirros-0.5.2-x86_64-disk.img
  120  mv /opt/stack/cirros-0.5.2-x86_64-disk.img ./
  121  ls
  122  cd ~
  123  ls
  124  cd devstack/
  125  ls
  126  ./stack.sh
  127  cd ..
  128  cd logs/
  129  ls
  130  grep -r create_neutron_initial_network
  131  vim stack.sh.log.2024-05-08-225210
  132  cd ~
  133  ls
  134  cd devstack/
  135  ls
  136  ./unstack.sh
  137  ./stack.sh
  138  ps aux | grep neutron
  139  ls
  140  cd ..
  141  ls
  142  cd logs/
  143  ls
  144  vim stack.sh.log.2024-05-08-225210
  145  vim stack.sh.log.2024-05-08-224938
  146  cd ..
  147  cd devstack/
  148  ls
  149  openstack --os-cloud devstack-admin --os-region RegionOne compute service list
  150  openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID -f value
  151  openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute -c ID
  152  openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller
  153  openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-controller --service nova-compute
  154  ps aux | grep nova
  155  ping devstack-controller
  156  cat /etc/hosts
  157  cd ..
  158  cd logs/
  159  ls
  160  grep -r "nova-compute"
  161  ps aux | grep libvirt
  162  ps aux | grep qemu
  163  ls
  164  cd /etc/systemd/system/
  165  ls
  166  cat devstack@n-cpu.service
  167  /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
  168  cd /var/run/libvirt/
  169  ls
  170  vim /etc/libvirt/libvirtd.conf
  171  cd ~
  172  ls
  173  cd logs/
  174  ls
  175  grep -r "libvirt"
  176  :q:q
  177  :q
  178  exit
  179  ls
  180  sudo systemctl restart libvirtd.service
  181  ps aux | grep libvirt
  182  ps aux | grep compute
  183  cat /etc/systemd/system/devstack@n-cpu.service
  184  /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
  185  sudo apt-get install libvirt-bin
  186  yum search libvirt
  187  apt-get search libvirt
  188  apt-cache search libvirt
  189  apt-cache madison libvirt
  190  sudo apt-get install libvirt-clients libvirt-daemon libvirt-daemon-system
  191  ls
  192  cd ~
  193  ls
  194  exit
  195  ls
  196  cd devstack/
  197  ls
  198  history

+ functions-common:real_install_package:1348 :   apt_get install qemu-system libvirt-clients libvirt-daemon-system libvirt-dev pi
+ functions-common:apt_get:1128            :   sudo DEBIAN_FRONTEND=noninteractive http_proxy= https_proxy= no_proxy= apt-get --option Dpkg::Options::=--force-confold --assume-yes install qemu-system libvirt-clients libvirt-daemon-system libvirt-dev python3-libvirt
Reading package lists...
Building dependency tree...
Reading state information...
qemu-system is already the newest version (1:2.11+dfsg-1ubuntu7.42).
The following packages were automatically installed and are no longer required:
  python3-keyring python3-keyrings.alt python3-secretstorage python3-wheel
  python3-xdg
Use 'sudo apt autoremove' to remove them.
The following additional packages will be installed:
  libvirt-daemon libvirt-daemon-driver-storage-rbd libvirt0
Suggested packages:
  libvirt-daemon-driver-storage-gluster libvirt-daemon-driver-storage-sheepdog
  libvirt-daemon-driver-storage-zfs numad auditd systemtap zfsutils
The following NEW packages will be installed:
  libvirt-clients libvirt-daemon libvirt-daemon-driver-storage-rbd
  libvirt-daemon-system libvirt-dev libvirt0 python3-libvirt
Preconfiguring packages ...
0 upgraded, 7 newly installed, 0 to remove and 6 not upgraded.
Need to get 0 B/4,385 kB of archives.
After this operation, 19.2 MB of additional disk space will be used.
Selecting previously unselected package libvirt0:amd64.
(Reading database ... 91885 files and directories currently installed.)
Preparing to unpack .../0-libvirt0_4.0.0-1ubuntu8.21_amd64.deb ...
Unpacking libvirt0:amd64 (4.0.0-1ubuntu8.21) ...
Selecting previously unselected package libvirt-clients.
Preparing to unpack .../1-libvirt-clients_4.0.0-1ubuntu8.21_amd64.deb ...
Unpacking libvirt-clients (4.0.0-1ubuntu8.21) ...
Selecting previously unselected package libvirt-daemon.
Preparing to unpack .../2-libvirt-daemon_4.0.0-1ubuntu8.21_amd64.deb ...
Unpacking libvirt-daemon (4.0.0-1ubuntu8.21) ...
Selecting previously unselected package libvirt-daemon-system.
Preparing to unpack .../3-libvirt-daemon-system_4.0.0-1ubuntu8.21_amd64.deb ...
Unpacking libvirt-daemon-system (4.0.0-1ubuntu8.21) ...
Selecting previously unselected package libvirt-daemon-driver-storage-rbd.
Preparing to unpack .../4-libvirt-daemon-driver-storage-rbd_4.0.0-1ubuntu8.21_amd64.deb ...
Unpacking libvirt-daemon-driver-storage-rbd (4.0.0-1ubuntu8.21) ...
Selecting previously unselected package libvirt-dev:amd64.
Preparing to unpack .../5-libvirt-dev_4.0.0-1ubuntu8.21_amd64.deb ...
Unpacking libvirt-dev:amd64 (4.0.0-1ubuntu8.21) ...
Selecting previously unselected package python3-libvirt.
Preparing to unpack .../6-python3-libvirt_4.0.0-1_amd64.deb ...
Unpacking python3-libvirt (4.0.0-1) ...
Setting up libvirt0:amd64 (4.0.0-1ubuntu8.21) ...
Setting up libvirt-daemon (4.0.0-1ubuntu8.21) ...
Setting up libvirt-clients (4.0.0-1ubuntu8.21) ...
Setting up python3-libvirt (4.0.0-1) ...
Setting up libvirt-dev:amd64 (4.0.0-1ubuntu8.21) ...
Setting up libvirt-daemon-system (4.0.0-1ubuntu8.21) ...
Adding user libvirt-qemu to group libvirt-qemu
Default libvirt network on 192.168.122.1/24 already taken
Changing to free 192.168.123.1/24
Enabling libvirt default network
Created symlink /etc/systemd/system/multi-user.target.wants/libvirt-guests.service → /usr/local/lib/systemd/system/libvirt-guests.service.
Created symlink /etc/systemd/system/multi-user.target.wants/libvirtd.service → /usr/local/lib/systemd/system/libvirtd.service.
Created symlink /etc/systemd/system/sockets.target.wants/virtlockd.socket → /usr/local/lib/systemd/system/virtlockd.socket.
Created symlink /etc/systemd/system/sockets.target.wants/virtlogd.socket → /usr/local/lib/systemd/system/virtlogd.socket.
virtlockd.service is a disabled or a static unit, not starting it.
Job for libvirt-guests.service failed because the control process exited with error code.
See "systemctl status libvirt-guests.service" and "journalctl -xe" for details.
invoke-rc.d: initscript libvirt-guests, action "start" failed.
● libvirt-guests.service - Suspend/Resume Running libvirt Guests
   Loaded: loaded (/usr/local/lib/systemd/system/libvirt-guests.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2024-05-09 17:24:09 CST; 6ms ago
     Docs: man:libvirtd(8)
           https://libvirt.org
  Process: 9785 ExecStart=/usr/local/libexec/libvirt-guests.sh start (code=exited, status=2)
 Main PID: 9785 (code=exited, status=2)

May 09 17:24:09 devstack-controller systemd[1]: Starting Suspend/Resume Running libvirt Guests...
May 09 17:24:09 devstack-controller libvirt-guests.sh[9785]: /usr/local/libexec/libvirt-guests.sh: 29: .: Can't open /usr/local/bin/gettext.sh
May 09 17:24:09 devstack-controller systemd[1]: libvirt-guests.service: Main process exited, code=exited, status=2/INVALIDARGUMENT
May 09 17:24:09 devstack-controller systemd[1]: libvirt-guests.service: Failed with result 'exit-code'.
May 09 17:24:09 devstack-controller systemd[1]: Failed to start Suspend/Resume Running libvirt Guests.
dpkg: error processing package libvirt-daemon-system (--configure):
 installed libvirt-daemon-system package post-installation script subprocess returned error exit status 1
Setting up libvirt-daemon-driver-storage-rbd (4.0.0-1ubuntu8.21) ...
Processing triggers for systemd (237-3ubuntu10.57) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
Processing triggers for ureadahead (0.100.0-21) ...
Processing triggers for libc-bin (2.27-3ubuntu1.6) ...
Errors were encountered while processing:
 libvirt-daemon-system
E: Sub-process /usr/bin/dpkg returned an error code (1)


stack@devstack-controller:~/devstack$ grep -r "libvirt"
functions:    # NOTE(danms): If we're on libvirt/qemu or libvirt/kvm, set the hw_rng_model
functions:    # to libvirt in the image properties.
functions:    if [[ "$VIRT_DRIVER" == "libvirt" ]]; then
files/rpms-suse/nova:libvirt # NOPRIME
files/rpms-suse/nova:libvirt-python # NOPRIME
tools/image_list.sh:DRIVERS="openvz ironic libvirt vsphere dummy"
tools/fixup_stuff.sh:        # Enable UCA:ussuri for updated versions of QEMU and libvirt
tools/fixup_stuff.sh:        # On Fedora 20 firewalld interacts badly with libvirt and
tools/fixup_stuff.sh:        # firewalld hanging after install of libvirt with polkit [1].
.zuul.yaml:        LIBVIRT_TYPE: '{{ devstack_libvirt_type | default("qemu") }}'
.zuul.yaml:        /var/log/libvirt: logs
lib/nova:QEMU_CONF=/etc/libvirt/qemu.conf
lib/nova:        if [[ "$VIRT_DRIVER" = 'libvirt' ]]; then
lib/nova:    if [[ "$VIRT_DRIVER" == "libvirt" && "$LIBVIRT_TYPE" == "qemu" ]]; then
lib/nova:        iniset $NOVA_CPU_CONF workarounds libvirt_disable_apic True
lib/nova:    if [[ "$VIRT_DRIVER" = 'libvirt' ]]; then
lib/tempest:    # in Cinder and the libvirt driver in Nova.
lib/tempest:    if [[ "$CINDER_ENABLED_BACKENDS" == *"lvm"* ]] && [ "$VIRT_DRIVER" = "libvirt" ]; then
lib/tempest:    if [ "$VIRT_DRIVER" = "libvirt" ]; then
lib/tempest:    if [ "$VIRT_DRIVER" = "libvirt" ] && [ "$LIBVIRT_TYPE" = "lxc" ]; then
lib/tempest:        # libvirt-lxc does not support boot from volume or attaching volumes
lib/neutron_plugins/ovn_agent:function _disable_libvirt_apparmor {
lib/neutron_plugins/ovn_agent:    # of libvirt to work with ovs configured ports. See LP#1466631.
lib/neutron_plugins/ovn_agent:    # disables apparmor for libvirtd
lib/neutron_plugins/ovn_agent:    sudo aa-complain /etc/apparmor.d/usr.sbin.libvirtd
lib/neutron_plugins/ovn_agent:    _disable_libvirt_apparmor
lib/nova_plugins/functions-libvirt:# lib/nova_plugins/functions-libvirt
lib/nova_plugins/functions-libvirt:# Common libvirt configuration functions
lib/nova_plugins/functions-libvirt:# Turn on selective debug log filters for libvirt.
lib/nova_plugins/functions-libvirt:# 'configure_libvirt' function further below are _selective_ and not
lib/nova_plugins/functions-libvirt:# Try to enable coredumps for libvirt
lib/nova_plugins/functions-libvirt:# Enable coredumps for libvirt
lib/nova_plugins/functions-libvirt:    local confdir=/etc/systemd/system/libvirtd.service.d
lib/nova_plugins/functions-libvirt:# Installs required distro-specific libvirt packages.
lib/nova_plugins/functions-libvirt:function install_libvirt {
lib/nova_plugins/functions-libvirt:    # NOTE(yoctozepto): The common consensus [1] is that libvirt-python should
lib/nova_plugins/functions-libvirt:    # The following line removes libvirt-python from upper-constraints and
lib/nova_plugins/functions-libvirt:    # explicitly depend on a newer (or, in general, incompatible) libvirt-python
lib/nova_plugins/functions-libvirt:            $REQUIREMENTS_DIR/upper-constraints.txt -- libvirt-python
lib/nova_plugins/functions-libvirt:        install_package qemu-system libvirt-clients libvirt-daemon-system libvirt-dev python3-libvirt
lib/nova_plugins/functions-libvirt:        install_package libvirt libvirt-devel python3-libvirt
lib/nova_plugins/functions-libvirt:# Configures the installed libvirt system so that is accessible by
lib/nova_plugins/functions-libvirt:function configure_libvirt {
lib/nova_plugins/functions-libvirt:        cat <<EOF | sudo tee $rules_dir/50-libvirt-$STACK_USER.rules
lib/nova_plugins/functions-libvirt:    if (action.id == 'org.libvirt.unix.manage' &&
lib/nova_plugins/functions-libvirt:    # The user that nova runs as needs to be member of **libvirtd** group otherwise
lib/nova_plugins/functions-libvirt:    # nova-compute will be unable to use libvirt.
lib/nova_plugins/functions-libvirt:    # Enable server side traces for libvirtd
lib/nova_plugins/functions-libvirt:            # of '1:libvirt' making everything turn on. So use libvirt.c for now.
lib/nova_plugins/functions-libvirt:            # This will have to be re-visited when Ubuntu ships libvirt >= 1.2.3
lib/nova_plugins/functions-libvirt:            local log_filters="1:libvirt.c 1:qemu 1:conf 1:security 3:object 3:event 3:json 3:file 1:util 1:cpu"
lib/nova_plugins/functions-libvirt:            local log_filters="1:libvirt 1:qemu 1:conf 1:security 3:object 3:event 3:json 3:file 1:util 1:cpu"
lib/nova_plugins/functions-libvirt:        local log_outputs="1:file:/var/log/libvirt/libvirtd.log"
lib/nova_plugins/functions-libvirt:        if ! sudo grep -q "^log_filters=\"$log_filters\"" /etc/libvirt/libvirtd.conf; then
lib/nova_plugins/functions-libvirt:            echo "log_filters=\"$log_filters\"" | sudo tee -a /etc/libvirt/libvirtd.conf
lib/nova_plugins/functions-libvirt:        if ! sudo grep -q "^log_outputs=\"$log_outputs\"" /etc/libvirt/libvirtd.conf; then
lib/nova_plugins/functions-libvirt:            echo "log_outputs=\"$log_outputs\"" | sudo tee -a /etc/libvirt/libvirtd.conf
lib/nova_plugins/functions-libvirt:        sudo mkdir -p /etc/pki/libvirt-vnc
lib/nova_plugins/functions-libvirt:        deploy_int_CA /etc/pki/libvirt-vnc/ca-cert.pem
lib/nova_plugins/functions-libvirt:        deploy_int_cert /etc/pki/libvirt-vnc/server-cert.pem /etc/pki/libvirt-vnc/server-key.pem
lib/nova_plugins/functions-libvirt:        # Change ownership of everything under /etc/pki/libvirt-vnc to
lib/nova_plugins/functions-libvirt:        # libvirt-qemu:libvirt-qemu so that libvirt-qemu can read the key
lib/nova_plugins/functions-libvirt:        sudo chown -R libvirt-qemu:libvirt-qemu /etc/pki/libvirt-vnc
lib/nova_plugins/functions-libvirt:    restart_service libvirtd
lib/nova_plugins/functions-libvirt:    #  https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1577455
lib/nova_plugins/functions-libvirt:    # (not all platforms have it; libvirt 1.3+ only, thus the ignore)
lib/nova_plugins/hypervisor-libvirt:# lib/nova_plugins/hypervisor-libvirt
lib/nova_plugins/hypervisor-libvirt:# Configure the libvirt hypervisor
lib/nova_plugins/hypervisor-libvirt:# VIRT_DRIVER=libvirt
lib/nova_plugins/hypervisor-libvirt:source $TOP_DIR/lib/nova_plugins/functions-libvirt
lib/nova_plugins/hypervisor-libvirt:    configure_libvirt
lib/nova_plugins/hypervisor-libvirt:    iniset $NOVA_CONF libvirt virt_type "$LIBVIRT_TYPE"
lib/nova_plugins/hypervisor-libvirt:    iniset $NOVA_CONF libvirt cpu_mode "$LIBVIRT_CPU_MODE"
lib/nova_plugins/hypervisor-libvirt:    iniset $NOVA_CONF libvirt live_migration_uri "qemu+ssh://$STACK_USER@%s/system"
lib/nova_plugins/hypervisor-libvirt:    iniset $NOVA_CONF DEFAULT compute_driver "libvirt.LibvirtDriver"
lib/nova_plugins/hypervisor-libvirt:        iniset $NOVA_CONF libvirt cpu_mode "host-passthrough"
lib/nova_plugins/hypervisor-libvirt:            iniset $NOVA_CONF libvirt inject_partition '-1'
lib/nova_plugins/hypervisor-libvirt:        iniset $NOVA_CONF libvirt connection_uri "parallels+unix:///system"
lib/nova_plugins/hypervisor-libvirt:        iniset $NOVA_CONF libvirt images_type "ploop"
lib/nova_plugins/hypervisor-libvirt:        iniset $NOVA_CONF libvirt images_type "lvm"
lib/nova_plugins/hypervisor-libvirt:        iniset $NOVA_CONF libvirt images_volume_group $DEFAULT_VOLUME_GROUP_NAME
lib/nova_plugins/hypervisor-libvirt:            iniset $NOVA_CONF libvirt volume_clear "$LVM_VOLUME_CLEAR"
lib/nova_plugins/hypervisor-libvirt:    install_libvirt
lib/nova_plugins/hypervisor-ironic:source $TOP_DIR/lib/nova_plugins/functions-libvirt
lib/nova_plugins/hypervisor-ironic:        configure_libvirt
lib/nova_plugins/hypervisor-ironic:    install_libvirt
lib/glance:    if [ "$VIRT_DRIVER" = 'libvirt' ] && [ "$LIBVIRT_TYPE" = 'parallels' ]; then
stack.sh:# pages if KSM is enabled. This is particularly useful for nova + libvirt
stackrc:    # Nova - services to support libvirt based openstack clouds
stackrc:# libvirt backends. This reduces memory usage at the cost of CPU overhead
stackrc:# volume multiattach is supported. In Queens, only the libvirt compute driver
stackrc:# or libvirt must be greater than or equal to 3.10.
stackrc:# Nova hypervisor configuration.  We default to libvirt with **kvm** but will
stackrc:DEFAULT_VIRT_DRIVER=libvirt
stackrc:    ironic|libvirt)
stackrc:            # The groups change with newer libvirt. Older Ubuntu used
stackrc:            # 'libvirtd', but now uses libvirt like Debian. Do a quick check
stackrc:            # to see if libvirtd group already exists to handle grenade's case.
stackrc:            LIBVIRT_GROUP=$(cut -d ':' -f 1 /etc/group | grep 'libvirtd$' || true)
stackrc:            LIBVIRT_GROUP=${LIBVIRT_GROUP:-libvirt}
stackrc:            LIBVIRT_GROUP=libvirtd
stackrc:        libvirt)
stackrc:            # Use the same as the default for libvirt
doc/source/guides/devstack-with-nested-kvm.rst:Edit the VM's libvirt XML configuration via ``virsh`` utility:
doc/source/guides/devstack-with-nested-kvm.rst:libvirt driver in nova, the below config attribute can be used in
doc/source/guides/multinode-lab.rst:    sudo rm -rf /etc/libvirt/qemu/inst*
doc/source/guides/multinode-lab.rst:    [libvirt]
doc/source/guides/multinode-lab.rst:The above steps are necessary because libvirtd runs as root when the
doc/source/guides/multinode-lab.rst:information, see the `libvirt documentation`_.
doc/source/guides/multinode-lab.rst:.. _libvirt documentation: https://libvirt.org/drvqemu.html#securitydriver
doc/source/plugin-registry.rst:x/devstack-plugin-libvirt-qemu           `https://opendev.org/x/devstack-plugin-libvirt-qemu <https://opendev.org/x/devstack-plugin-libvirt-qemu>`__
doc/source/zuul_ci_jobs_migration.rst:     - *LIBVIRT_TYPE: [libvirt type]* in devstack_localrc in the job
doc/source/systemd.rst:  Group = libvirt
doc/source/systemd.rst:  sg libvirt -c '/usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf'
Binary file .git/objects/pack/pack-d16f0396cca877c287a62880f6fb3b41c135de06.pack matches
Binary file .git/index matches


 vim lib/nova_plugins/functions-libvirt

INFO nova.virt.driver [None req-d0bdd1f6-17fd-4e83-8ca1-38e7920d0d7d None None] Loading compute driver 'libvirt.LibvirtDriver'
ERROR nova.virt.driver [None req-d0bdd1f6-17fd-4e83-8ca1-38e7920d0d7d None None] Unable to load the virtualization driver: ModuleNotFoundError: No module named 'libvirt'
ERROR nova.virt.driver Traceback (most recent call last):
ERROR nova.virt.driver   File "/opt/stack/nova/nova/virt/driver.py", line 1818, in load_compute_driver
ERROR nova.virt.driver     virtapi)
ERROR nova.virt.driver   File "/usr/local/lib/python3.6/dist-packages/oslo_utils/importutils.py", line 44, in import_object
ERROR nova.virt.driver     return import_class(import_str)(*args, **kwargs)
ERROR nova.virt.driver   File "/opt/stack/nova/nova/virt/libvirt/driver.py", line 432, in __init__
ERROR nova.virt.driver     libvirt = importutils.import_module('libvirt')
ERROR nova.virt.driver   File "/usr/local/lib/python3.6/dist-packages/oslo_utils/importutils.py", line 73, in import_module
ERROR nova.virt.driver     __import__(import_str)
ERROR nova.virt.driver ModuleNotFoundError: No module named 'libvirt'
ERROR nova.virt.driver
stack@devstack-controller:/etc/systemd/system$ pip search libvirt
/usr/lib/python3/dist-packages/secretstorage/dhcrypto.py:15: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
/usr/lib/python3/dist-packages/secretstorage/util.py:19: CryptographyDeprecationWarning: int_from_bytes is deprecated, use int.from_bytes instead
  from cryptography.utils import int_from_bytes
ERROR: XMLRPC request failed [code: -32500]
RuntimeError: PyPI no longer supports 'pip search' (or XML-RPC search). Please use https://pypi.org/search (via a browser) instead. See https://warehouse.pypa.io/api-reference/xml-rpc.html#deprecated-methods for more information.
s

https://blog.csdn.net/liushall/article/details/124498509

--------------------

=========================
DevStack Component Timing
 (times are in seconds)
=========================
wait_for_service      10
pip_install          115
apt-get               11
run_process           13
dbsync                42
git_timed            248
apt-get-update        11
test_with_retry        2
async_wait             0
osc                  103
-------------------------
Unaccounted time     823
=========================
Total runtime        1378



This is your host IP address: 192.168.10.8
This is your host IPv6 address: ::1
Horizon is now available at http://192.168.10.8/dashboard
Keystone is serving at http://192.168.10.8/identity/
The default users are: admin and demo
The password: admin

Services are running under systemd unit files.
For more information see:
https://docs.openstack.org/devstack/latest/systemd.html

DevStack Version: wallaby
Change: ec783f0b044012d3d7e1410d3b599e67fc9dd624 Drop the devstack-single-node-centos-7 nodeset 2024-03-04 19:50:20 +0000
OS Version: Ubuntu 20.04 focal

//////////////安装成功controller节点

/etc/hosts
192.168.10.8 devstack-controller
192.168.10.9 devstack-compute

root@devstack-controller:~# history
    1  ls
    2  apt-get update
    3  apt-get install libvirt-bin
    4  apt-cache search libvirt
    5  apt-get install libvirt-clients libvirt-daemon
    6  apt-cache
    7  apt-cache show libvirt-daemon
    8  git clone https://git.openstack.org/openstack-dev/devstack -b unmaintained/wallaby
    9  devstack/tools/create-stack-user.sh
   10  mv devstack /opt/stack
   11  chown -R stack:stack /opt/stack/devstack
   12  su - stack
   13  history

stack@devstack-controller:~/devstack$ history
    1  cd devstack/
    2  ls
    3  vim inc/python
# Wrapper for ``pip install`` to set cache and proxy environment variables
# Uses globals ``OFFLINE``, ``PIP_VIRTUAL_ENV``,
# ``PIP_UPGRADE``, ``*_proxy``,
# Usage:
#  pip_install pip_arguments
function pip_install {
    local xtrace result
    xtrace=$(set +o | grep xtrace)
    set +o xtrace
    local upgrade=""
    local offline=${OFFLINE:-False}
    if [[ "$offline" == "True" || -z "$@" ]]; then
        $xtrace
        return
    fi

    time_start "pip_install"

    PIP_UPGRADE=$(trueorfalse False PIP_UPGRADE)
    if [[ "$PIP_UPGRADE" = "True" ]] ; then
        upgrade="--upgrade"
    fi

    if [[ -z "$os_PACKAGE" ]]; then
        GetOSVersion
    fi

    # Try to extract the path of the package we are installing into
    # package_dir.  We need this to check for test-requirements.txt,
    # at least.
    #
    # ${!#} expands to the last positional argument to this function.
    # With "extras" syntax included, our arguments might be something
    # like:
    #  -e /path/to/fooproject[extra]
    # Thus this magic line grabs just the path without extras
    #
    # Note that this makes no sense if this is a pypi (rather than
    # local path) install; ergo you must check this path exists before
    # use.  Also, if we had multiple or mixed installs, we would also
    # likely break.  But for historical reasons, it's basically only
    # the other wrapper functions in here calling this to install
    # local packages, and they do so with single call per install.  So
    # this works (for now...)
    local package_dir=${!#%\[*\]}

    if [[ -n ${PIP_VIRTUAL_ENV:=} && -d ${PIP_VIRTUAL_ENV} ]]; then
        local cmd_pip=$PIP_VIRTUAL_ENV/bin/pip
        local sudo_pip="env"
    else
        local cmd_pip="python$PYTHON3_VERSION -m pip"
        # See
        #  https://github.com/pypa/setuptools/issues/2232
        #  http://lists.openstack.org/pipermail/openstack-discuss/2020-August/016905.html
        # this makes setuptools >=50 use the platform distutils.
        # We only want to do this on global pip installs, not if
        # installing in a virtualenv
        local sudo_pip="sudo -H LC_ALL=en_US.UTF-8 SETUPTOOLS_USE_DISTUTILS=stdlib "
        echo "Using python $PYTHON3_VERSION to install $package_dir"
    fi

    cmd_pip="$cmd_pip install"
    # Always apply constraints
    cmd_pip="$cmd_pip -c $REQUIREMENTS_DIR/upper-constraints.txt"

    $xtrace

    $sudo_pip \
        http_proxy="${http_proxy:-}" \
        https_proxy="${https_proxy:-}" \
        no_proxy="${no_proxy:-}" \
        PIP_FIND_LINKS=$PIP_FIND_LINKS \
        $cmd_pip $upgrade \
        $@ \
        -i https://pypi.tuna.tsinghua.edu.cn/simple \
        --default-timeout=30000
    result=$?

    time_stop "pip_install"
    return $result
}
    4  vim lib/tempest
# install_tempest() - Collect source and prepare
function install_tempest {
    git_clone $TEMPEST_REPO $TEMPEST_DIR $TEMPEST_BRANCH
    # NOTE(gmann): Pinning tox<4.0.0 for stable/zed and lower. Tox 4.0.0
    # released after zed was released and has some incompatible changes
    # and it is ok not to fix the issues caused by tox 4.0.0 in stable
    # beanches jobs. We can continue testing the stable/zed and lower
    # branches with tox<4.0.0
    pip_install 'tox!=2.8.0,<4.0.0'
    pushd $TEMPEST_DIR
    # NOTE(gmann): checkout the TEMPEST_BRANCH in case TEMPEST_BRANCH
    # is tag name not master. git_clone would not checkout tag because
    # TEMPEST_DIR already exist until RECLONE is true.
    git checkout $TEMPEST_BRANCH

    local tmp_u_c_m
    tmp_u_c_m=$(mktemp -t tempest_u_c_m.XXXXXXXXXX)
    set_tempest_venv_constraints $tmp_u_c_m

    tox -r --notest -efull -i https://pypi.tuna.tsinghua.edu.cn/simple
    # NOTE(mtreinish) Respect constraints in the tempest full venv, things that
    # are using a tox job other than full will not be respecting constraints but
    # running pip install -U on tempest requirements
    $TEMPEST_DIR/.tox/tempest/bin/pip install -c $tmp_u_c_m -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
    PROJECT_VENV["tempest"]=${TEMPEST_DIR}/.tox/tempest
    rm -f $tmp_u_c_m
    popd
}
++ lib/tempest:configure_tempest:642        :   tox -revenv-tempest --notest

    5  grep -r "ENABLED_SERVICES"
    6  vim stackrc
# Set the target branch. This is used so that stable branching
# does not need to update each repo below.
TARGET_BRANCH=unmaintained/wallaby
    7  vim local.conf
root@devstack-controller:/opt/stack/devstack# cat local.conf
[[local|localrc]]
MULTI_HOST=true
HOST_IP=192.168.10.8
LOGFILE=/opt/stack/logs/stack.sh.log

# Credentials
ADMIN_PASSWORD=admin
MYSQL_PASSWORD=secret
RABBIT_PASSWORD=secret
SERVICE_PASSWORD=secret
SERVICE_TOKEN=abcdefghijklmnopqrstuvwxyz

# enable neutron-ml2-vlan
disable_service n-net
enable_service q-svc,q-agt,q-dhcp,q-l3,q-meta,neutron,q-lbaas,q-fwaas,q-vpn
Q_AGENT=openvswitch
ENABLE_TENANT_VLANS=True
TENANT_VLAN_RANGE=3001:4000
PHYSICAL_NETWORK=default

LOG_COLOR=False
LOGDIR=$DEST/logs
SCREEN_LOGDIR=$LOGDIR/screen
    8  ip addr
    9  cd /opt/stack/devstack/files/
   10  ls
   11  wget https://github.com/etcd-io/etcd/releases/download/v3.3.12/etcd-v3.3.12-linux-amd64.tar.gz
   12  ls
   13  rm etcd-v3.3.12-linux-amd64.tar.gz
   14  ls
   15  mv /opt/stack/etcd-v3.3.12-linux-amd64.tar.gz ./
   16  ls
   17  cd ..
   18  ls
   19  cat stackrc
   20  ls
   21  vim stackrc
   22  ./stack.sh
   23  curl -f --retry 6 --retry-delay 5 -o /opt/stack/devstack/files/get-pip.py https://bootstrap.pypa.io/get-pip.py
   24  ./stack.sh
   25  sudo -H -E python3.8 /opt/stack/devstack/files/get-pip.py
   26  ./stack.sh
   27  git clone https://github.com/novnc/noVNC.git /opt/stack/noVNC --branch v1.1.0
   28  ls
   29  cd ..
   30  ls
   31  pwd
   32  unzip noVNC-1.1.0.zip
   33  ls
   34  cd noVNC-1.1.0/
   35  ls
   36  cd ..
   37  ls
   38  mv noVNC-1.1.0 noVNC
   39  ls
   40  rm -rf noVNC
   41  ls
   42  cd noVNC/
   43  ls
   44  git status
   45  ls -l
   46  cd ..
   47  ls -l
   48  sudo chown -R stack:stack noVNC
   49  sudo chown -R stack:stack cirros-0.5.2-x86_64-disk.img
   50  ls
   51  cd noVNC/
   52  ls
   53  git status
   54  ls
   55  cd ..
   56  ls
   57  cd devstack/
   58  ls
   59  ./stack.sh
   60  history

///////////安装成功compute节点

/etc/hosts
192.168.10.8 devstack-controller
192.168.10.9 devstack-compute

root@devstack-compute:~# history
    1  ls
    2  apt-get update
    3  apt-get install git
    4  git clone https://git.openstack.org/openstack-dev/devstack -b unmaintained/wallaby
    5  devstack/tools/create-stack-user.sh
    6  mv devstack /opt/stack
    7  chown -R stack:stack /opt/stack/devstack
    8  su - stack
    9  vim /etc/hosts
   10  su - stack
   11  history

stack@devstack-compute:~/devstack$ history
    1  ls
    2  cd devstack/
    3  ls
    4  vim inc/python
    5  vim lib/tempest
    6  vim stackrc
stack@devstack-compute:~/devstack$ cat local.conf
[[local|localrc]]
MULTI_HOST=true
HOST_IP=192.168.10.9

# Credentials
ADMIN_PASSWORD=admin
MYSQL_PASSWORD=secret
RABBIT_PASSWORD=secret
SERVICE_PASSWORD=secret
SERVICE_TOKEN=abcdefghijklmnopqrstuvwxyz

# Service information
SERVICE_HOST=192.168.10.8
MYSQL_HOST=$SERVICE_HOST
RABBIT_HOST=$SERVICE_HOST
GLANCE_HOSTPORT=$SERVICE_HOST:9292
Q_HOST=$SERVICE_HOST
KEYSTONE_AUTH_HOST=$SERVICE_HOST
KEYSTONE_SERVICE_HOST=$SERVICE_HOST
CEILOMETER_BACKEND=mongodb
DATABASE_TYPE=mysql
ENABLED_SERVICES=n-cpu,q-agt,neutron,c-vol,placement-client
Q_AGENT=openvswitch
ENABLE_TENANT_VLANS=True
TENANT_VLAN_RANGE=3001:4000
PHYSICAL_NETWORK=default

# vnc config
NOVA_VNC_ENABLED=True
NOVNCPROXY_URL="http://$SERVICE_HOST:6080/vnc_lite.html"
VNCSERVER_LISTEN=$HOST_IP
VNCSERVER_PROXYCLIENT_ADDRESS=$VNCSERVER_LISTEN

LOG_COLOR=False
LOGDIR=$DEST/logs
SCREEN_LOGDIR=$LOGDIR/screen
    7  vim local.conf
    8  vim stackrc
    9  ./stack.sh
   10  openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-compute --service
   11  ps aux | grep nova
   12  ls
   13  cat /etc/hosts
   14  ip addr
   15  vim /etc/hosts
   16  exit
   17  ls
   18  openstack --os-cloud devstack-admin --os-region RegionOne compute service list --host devstack-compute --service
   19  cd devstack/
   20  ls
   21  ./stack.sh -h
   22  cat /etc/hosts
   23  ping devstack-compute
   24  ping devstack-controller
   25  ./stack.sh
   26  openstack --os-cloud devstack-admin --os-region RegionOne compute service list
   27  ls
   28  grep -r "OS_IDENTITY_API_VERSION"
   29  vim stack.sh
   30  cd ..
   31  ls
   32  cd logs/
   33  ls
   34  grep -r "Keystone is serving at"
   35  grep -r "Keystone"
   36  ls
   37  cd ..
   38  ls
   39  export OS_IDENTITY_API_VERSION=3
   40  export OS_AUTH_URL=http://192.168.10.8/identity/
   41  export OS_USERNAME=admin
   42  export OS_USER_DOMAIN_ID=default
   43  export OS_PASSWORD=secret
   44  export OS_PROJECT_NAME=admin
   45  export OS_PROJECT_DOMAIN_ID=default
   46  export OS_REGION_NAME=RegionOne
   47  openstack --os-cloud devstack-admin --os-region RegionOne compute service list
   48  openstack --debug --os-cloud devstack-admin --os-region RegionOne compute service list
   49  telnet 192.168.10.8 80
   50  cd devstack/
   51  ls
   52  ./unstack.sh
   53  ./stack.sh
   54  openstack --debug --os-cloud devstack-admin --os-region RegionOne compute service list
   55  telnet 192.168.10.8 80
   56  telnet 192.168.10.8 22
   57  telnet 192.168.10.8 8080
   58  ping 192.168.10.8
   59  ping 192.168.10.8 11011
   60  telnet 192.168.10.8 11011
   61  telnet 192.168.10.8 81
   62  ncat
   63  apt-get install ncat
   64  sudo apt-get install ncat
   65  ncat 192.168.10.8 81 打开安全组
   66  ls
   67  ncat 192.168.10.8 81
   68  ls
   69  ./unstack.sh
   70  ./stack.sh
   71  ps aux | grep nova
   72  cd /etc/systemd/system/
   73  ls
   74  cat devstack@n-cpu.service
   75  /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
   76  ls
   77  cd ~
   78  ls
   79  cd devstack/
   80  ls
   81  vim local.conf
   82  ls
   83  cd ..
   84  cd logs/
   85  ls
   86  cd ..
   87  ls
   88  cd devstack/
   89  ls
   90  vim local.conf
   91  cat /etc/nova/nova-cpu.conf
   92  ls
   93  vim /etc/nova/nova-cpu.conf
   94  /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
   95  vim /etc/nova/nova-cpu.conf
   96  /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
   97  vim /etc/nova/nova-cpu.conf
   98  /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
   99  vim /etc/nova/nova-cpu.conf
  100  /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
  101  vim /etc/nova/nova-cpu.conf
  102  /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
  103  cat /etc/nova/nova-cpu.conf
  104  ls
  105  grep -r "placement"
  106  vim lib/nova
  107  ls
  108  cat local.conf
  109  ls
  110  vim local.conf
  111  ./unstack.sh
  112  ./stack.sh
  113  history






///////////devstack 重启服务

Ceilometer  

Restart the Ceilometer services:

# service ceilometer-agent-central restart
# service ceilometer-api restart
# service ceilometer-agent-notification restart
# service ceilometer-collector status restart
Verify the status of the Ceilometer services. See Verify an OpenStack service status.

Cinder  

Restart the Cinder services:

# service cinder-api restart
# service cinder-scheduler restart
Verify the status of the Cinder services. See Verify an OpenStack service status.


On every node with Cinder role, run:

# service cinder-volume restart
# service cinder-backup restart
Verify the status of the cinder-volume and cinder-backup services.

Corosync/Pacemaker  

Restart the Corosync and Pacemaker services:

# service corosync restart
# service pacemaker restart
Verify the status of the Corosync and Pacemaker services. See Verify an OpenStack service status.

Repeat step 1 - 3 on all controller nodes.

Glance  
Log in to a controller node CLI.

Restart the Glance services:

# service glance-api restart
# service glance-registry restart
Verify the status of the Glance services. See Verify an OpenStack service status.

Repeat step 1 - 3 on all controller nodes.

Horizon 
Since the Horizon service is available through the Apache server, you should restart the Apache service on all controller nodes:

Log in to a controller node CLI.

Restart the Apache server:

# service apache2 restart
Verify whether the Apache service is successfully running after restart:

# service apache2 status
Verify whether the Apache ports are opened and listening:

# netstat -nltp | egrep apache2
Repeat step 1 - 3 on all controller nodes.

Ironic  
Log in to a controller node CLI.

Restart the Ironic services:

# service ironic-api restart
# service ironic-conductor restart
Verify the status of the Ironic services. See Verify an OpenStack service status.

Repeat step 1 - 3 on all controller nodes.

On any controller node, run the following command for the nova-compute service configured to work with Ironic:

# crm resource restart p_nova_compute_ironic
Verify the status of the p_nova_compute_ironic service.

Keystone    
Since the Keystone service is available through the Apache server, complete the following steps on all controller nodes:

Log in to a controller node CLI.

Restart the Apache server:

# service apache2 restart
Verify whether the Apache service is successfully running after restart:

# service apache2 status
Verify whether the Apache ports are opened and listening:

# netstat -nltp | egrep apache2
Repeat step 1 - 3 on all controller nodes.

MySQL   
Log in to any controller node CLI.

Run the following command:

# pcs status | grep -A1 mysql
In the output, the resource clone_p_mysql should be in the Started status.

Disable the clone_p_mysql resource:

# pcs resource disable clone_p_mysqld
Verify that the resource clone_p_mysqld is in the Stopped status:

# pcs status | grep -A2 mysql
It may take some time for this resource to be stopped on all controller nodes.

Disable the clone_p_mysql resource:

# pcs resource enable clone_p_mysqld
Verify that the resource clone_p_mysqld is in the Started status again on all controller nodes:

# pcs status | grep -A2 mysql
Warning

Use the pcs commands instead of crm for restarting the service. The pcs tool correctly stops the service according to the quorum policy preventing MySQL failures.

Neutron 
Use the following restart steps for the DHCP Neutron agent as an example for all Neutron agents.

Log in to any controller node CLI.

Verify the DHCP agent status:

# pcs resource show | grep -A1 neutron-dhcp-agent
The output should contain the list of all controllers in the Started status.

Stop the DHCP agent:

# pcs resource disable clone_neutron-dhcp-agent
Verify the Corosync status of the DHCP agent:

# pcs resource show | grep -A1 neutron-dhcp-agent
The output should contain the list of all controllers in the Stopped status.

Verify the neutron-dhcp-agent status on the OpenStack side:

# neutron agent-list
The output table should contain the DHCP agents for every controller node with xxx in the alive column.

Start the DHCP agent on every controller node:

# pcs resource enable clone_neutron-dhcp-agent
Verify the DHCP agent status:

# pcs resource show | grep -A1 neutron-dhcp-agent
The output should contain the list of all controllers in the Started status.

Verify the neutron-dhcp-agent status on the OpenStack side:

# neutron agent-list
The output table should contain the DHCP agents for every controller node with :-) in the alive column and True in the admin_state_up column.

Nova    
Log in to a controller node CLI.

Restart the Nova services:

# service nova-api restart
# service nova-cert restart
# service nova-compute restart
# service nova-conductor restart
# service nova-consoleauth restart
# service nova-novncproxy restart
# service nova-scheduler restart
# service nova-spicehtml5proxy restart
# service nova-xenvncproxy restart
Verify the status of the Nova services. See Verify an OpenStack service status.

Repeat step 1 - 3 on all controller nodes.

On every compute node, run:

# service nova-compute restart
Verify the status of the nova-compute service.

RabbitMQ    
Log in to any controller node CLI.

Disable the RabbitMQ service:

# pcs resource disable master_p_rabbitmq-server
Verify whether the service is stopped:

# pcs status | grep -A2 rabbitmq
Enable the service:

# pcs resource enable master_p_rabbitmq-server
During the startup process, the output of the pcs status command can show all existing RabbitMQ services in the Slaves mode.

Verify the service status:

# rabbitmqctl cluster_status
In the output, the running_nodes field should contain all controllers’ host names in the rabbit@<HOSTNAME> format. The partitions field should be empty.

Swift   
Log in to a controller node CLI.

Restart the Swift services:

# service swift-account-auditor restart
# service swift-account restart
# service swift-account-reaper restart
# service swift-account-replicator restart
# service swift-container-auditor restart
# service swift-container restart
# service swift-container-reconciler restart
# service swift-container-replicator restart
# service swift-container-sync restart
# service swift-container-updater restart
# service swift-object-auditor restart
# service swift-object restart
# service swift-object-reconstructor restart
# service swift-object-replicator restart
# service swift-object-updater restart
# service swift-proxy restart
Verify the status of the Swift services. See Verify an OpenStack service status.

Repeat step 1 - 3 on all controller nodes.

Operating on more than one unit at a time
Systemd supports wildcarding for unit operations. To restart every service in devstack you can do that following:

sudo systemctl restart devstack@*
Or to see the status of all Nova processes you can do:

sudo systemctl status devstack@n-*
We’ll eventually make the unit names a bit more meaningful so that it’s easier to understand what you are restarting.

https://docs.openstack.org/fuel-docs/newton/userdocs/fuel-user-guide/troubleshooting/service-status.html

由于新版devstack使用systemd的方式来管理OpenStack各项服务，所以查询日志的方式也有所不同，现记录：

systemd附带的主要功能之一是日志记录，这是一种访问日志的综合方式。这需要管理员通过 journalctl来进行访问。journalctl拥有强大的查询功能，我们从一些常见的选项开始。


查看特定的服务日志：
sudo journalctl -f --unit devstack@n-cpu.service

查看多个服务的日志：
sudo journalctl -f --unit devstack@n-cpu.service --unit devstack@n-cond.service

或者你可以使用通配符查看多个服务的日志：
sudo journalctl -f --unit devstack@n-*

使用更精准的时间戳：
sudo journalctl -f -o short-precise --unit devstack@n-cpu.service

使用ASCII编码格式，可以显示字体颜色和使用一些命令，比如less，也是使用 最多的命令：
sudo journalctl -a --unit devstack@n-cpu.service

使用grep命令结合journalctl使用，比如检索实例的 uuid：
sudo journalctl -a --unit devstack@n-* | grep 58391b5c-036f-44d5-bd68-21d3c26349e6

netstat -ntlp   //查看当前所有tcp端口
netstat -ntulp |grep 80   //查看所有80端口使用情况
netstat -an | grep 3306   //查看所有3306端口使用情况
netstat -nlp |grep LISTEN   //查看当前所有监听端口

Keystone is serving at http://192.168.10.8/identity/

export OS_IDENTITY_API_VERSION=3
export OS_AUTH_URL=http://192.168.10.8/identity/
export OS_USERNAME=admin
export OS_USER_DOMAIN_ID=default
export OS_PASSWORD=secret
export OS_PROJECT_NAME=admin
export OS_PROJECT_DOMAIN_ID=default
export OS_REGION_NAME=RegionOne


+ functions-common:save_stackenv:62        :   time_stamp=2024-05-10-154325
+ functions-common:save_stackenv:63        :   echo '# 2024-05-10-154325 '
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo BASE_SQL_CONN=mysql+pymysql://root:secret@192.168.10.8
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo DATA_DIR=/opt/stack/data
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo DEST=/opt/stack
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo ENABLED_SERVICES=n-cpu,q-agt,neutron
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo HOST_IP=192.168.10.9
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo KEYSTONE_SERVICE_URI=http://192.168.10.8/identity
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo LOGFILE=
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo OS_CACERT=
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo SERVICE_HOST=192.168.10.8
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo STACK_USER=stack
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo TLS_IP=
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo HOST_IPV6=::1
+ functions-common:save_stackenv:64        :   for i in $STACK_ENV_VARS
+ functions-common:save_stackenv:65        :   echo SERVICE_IP_VERSION=4
+ ./stack.sh:main:1405                     :   merge_config_group /opt/stack/devstack/local.conf extra
+ inc/meta-config:merge_config_group:171   :   local localfile=/opt/stack/devstack/local.conf

安全组需要开通

stack@devstack-compute:/etc/systemd/system$ /usr/local/bin/nova-compute --config-file /etc/nova/nova-cpu.conf
DEBUG os_vif [-] Loaded VIF plugin class '<class 'vif_plug_linux_bridge.linux_bridge.LinuxBridgePlugin'>' with name 'linux_bridge' {{(pid=125168) initialize /usr/local/lib/python3.8/dist-packages/os_vif/__init__.py:44}}
DEBUG os_vif [-] Loaded VIF plugin class '<class 'vif_plug_noop.noop.NoOpPlugin'>' with name 'noop' {{(pid=125168) initialize /usr/local/lib/python3.8/dist-packages/os_vif/__init__.py:44}}
DEBUG os_vif [-] Loaded VIF plugin class '<class 'vif_plug_ovs.ovs.OvsPlugin'>' with name 'ovs' {{(pid=125168) initialize /usr/local/lib/python3.8/dist-packages/os_vif/__init__.py:44}}
INFO os_vif [-] Loaded VIF plugins: linux_bridge, noop, ovs
DEBUG oslo_concurrency.processutils [-] Running cmd (subprocess): grep -F node.session.scan /sbin/iscsiadm {{(pid=125168) execute /usr/local/lib/python3.8/dist-packages/oslo_concurrency/processutils.py:384}}
DEBUG oslo_concurrency.processutils [-] CMD "grep -F node.session.scan /sbin/iscsiadm" returned: 0 in 0.005s {{(pid=125168) execute /usr/local/lib/python3.8/dist-packages/oslo_concurrency/processutils.py:422}}
CRITICAL nova [None req-27de18ff-84c3-41c7-996b-0b2fb79f58b2 None None] Unhandled error: keystoneauth1.exceptions.auth_plugins.MissingAuthPlugin: An auth plugin is required to determine endpoint URL
ERROR nova Traceback (most recent call last):
ERROR nova   File "/usr/local/bin/nova-compute", line 10, in <module>
ERROR nova     sys.exit(main())
ERROR nova   File "/opt/stack/nova/nova/cmd/compute.py", line 58, in main
ERROR nova     server = service.Service.create(binary='nova-compute',
ERROR nova   File "/opt/stack/nova/nova/service.py", line 252, in create
ERROR nova     service_obj = cls(host, binary, topic, manager,
ERROR nova   File "/opt/stack/nova/nova/service.py", line 116, in __init__
ERROR nova     self.manager = manager_class(host=self.host, *args, **kwargs)
ERROR nova   File "/opt/stack/nova/nova/compute/manager.py", line 535, in __init__
ERROR nova     self.reportclient = report.SchedulerReportClient()
ERROR nova   File "/opt/stack/nova/nova/scheduler/client/report.py", line 188, in __init__
ERROR nova     self._client = self._create_client()
ERROR nova   File "/opt/stack/nova/nova/scheduler/client/report.py", line 231, in _create_client
ERROR nova     client = self._adapter or utils.get_sdk_adapter('placement')
ERROR nova   File "/opt/stack/nova/nova/utils.py", line 989, in get_sdk_adapter
ERROR nova     return getattr(conn, service_type)
ERROR nova   File "/usr/local/lib/python3.8/dist-packages/openstack/service_description.py", line 93, in __get__
ERROR nova     endpoint = proxy_mod.Proxy.get_endpoint(proxy)
ERROR nova   File "/usr/local/lib/python3.8/dist-packages/keystoneauth1/adapter.py", line 291, in get_endpoint
ERROR nova     return self.session.get_endpoint(auth or self.auth, **kwargs)
ERROR nova   File "/usr/local/lib/python3.8/dist-packages/keystoneauth1/session.py", line 1241, in get_endpoint
ERROR nova     auth = self._auth_required(auth, 'determine endpoint URL')
ERROR nova   File "/usr/local/lib/python3.8/dist-packages/keystoneauth1/session.py", line 1181, in _auth_required
ERROR nova     raise exceptions.MissingAuthPlugin(msg_fmt % msg)
ERROR nova keystoneauth1.exceptions.auth_plugins.MissingAuthPlugin: An auth plugin is required to determine endpoint URL
ERROR nova


stack@devstack-controller:~/devstack$ cat /etc/nova/nova-cpu.conf

[DEFAULT]
vif_plugging_timeout = 300
vif_plugging_is_fatal = True
compute_driver = libvirt.LibvirtDriver
default_ephemeral_format = ext4
pointer_model = ps2mouse
graceful_shutdown_timeout = 5
metadata_workers = 2
osapi_compute_workers = 2
transport_url = rabbit://stackrabbit:secret@192.168.10.8:5672/nova_cell1
logging_exception_prefix = ERROR %(name)s %(instance)s
logging_default_format_string = %(color)s%(levelname)s %(name)s [-%(color)s] %(instance)s%(color)s%(message)s
logging_context_format_string = %(color)s%(levelname)s %(name)s [%(global_request_id)s %(request_id)s %(project_name)s %(user_name)s%(color)s] %(instance)s%(color)s%(message)s
logging_debug_format_suffix = {{(pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d}}
instances_path = /opt/stack/data/nova/instances
state_path = /opt/stack/data/nova
enabled_apis = osapi_compute
shutdown_timeout = 0
metadata_listen = 0.0.0.0
osapi_compute_listen = 0.0.0.0
instance_name_template = instance-%08x
my_ip = 192.168.10.8
rootwrap_config = /etc/nova/rootwrap.conf
allow_resize_to_same_host = True
debug = True

[wsgi]
api_paste_config = /etc/nova/api-paste.ini

[filter_scheduler]
track_instance_changes = False
enabled_filters = AvailabilityZoneFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,SameHostFilter,DifferentHostFilter

[scheduler]
workers = 2

[neutron]
service_metadata_proxy = True
region_name = RegionOne
auth_strategy = keystone
project_domain_name = Default
project_name = service
user_domain_name = Default
password = secret
username = neutron
auth_url = http://192.168.10.8/identity
auth_type = password
default_floating_pool = public

[key_manager]
fixed_key = bae3516cc1c0eb18b05440eba8012a4a880a2ee04d584a9c1579445e675b12defdc716ec
backend = nova.keymgr.conf_key_mgr.ConfKeyManager

[database]

[api_database]

[cache]
memcache_servers = localhost:11211
backend = dogpile.cache.memcached
enabled = True

[keystone_authtoken]
memcached_servers = localhost:11211
cafile = /opt/stack/data/ca-bundle.pem
project_domain_name = Default
project_name = service
user_domain_name = Default
password = secret
username = nova
auth_url = http://192.168.10.8/identity
interface = public
auth_type = password

[cinder]
project_domain_name = Default
project_name = service
user_domain_name = Default
password = secret
username = nova
auth_url = http://192.168.10.8/identity
auth_type = password
os_region_name = RegionOne

[oslo_concurrency]
lock_path = /opt/stack/data/nova

[upgrade_levels]
compute = auto

[oslo_messaging_notifications]
transport_url = rabbit://stackrabbit:secret@192.168.10.8:5672/
driver = messagingv2

[notifications]
notification_format = unversioned

[conductor]
workers = 2

[service_user]
auth_strategy = keystone
project_domain_name = Default
project_name = service
user_domain_name = Default
password = secret
username = nova
auth_url = http://192.168.10.8/identity
auth_type = password
send_service_user_token = True

[libvirt]
live_migration_uri = qemu+ssh://stack@%s/system
cpu_mode = none
virt_type = qemu

[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
user_domain_name = Default
password = secret
username = placement
auth_url = http://192.168.10.8/identity
auth_type = password

[workarounds]
libvirt_disable_apic = True
disable_group_policy_check_upcall = True

[vnc]
server_proxyclient_address = 192.168.10.8
server_listen = 0.0.0.0
novncproxy_base_url = http://192.168.10.8:6080/vnc_lite.html

[spice]
html5proxy_base_url = http://192.168.10.8:6081/spice_auto.html

stack@devstack-compute:~/devstack$ cat /etc/nova/nova-cpu.conf

[DEFAULT]
vif_plugging_timeout = 300
vif_plugging_is_fatal = True
compute_driver = libvirt.LibvirtDriver
default_ephemeral_format = ext4
pointer_model = ps2mouse
graceful_shutdown_timeout = 5
metadata_workers = 2
osapi_compute_workers = 2
transport_url = rabbit://stackrabbit:secret@192.168.10.8:5672/nova_cell1
logging_exception_prefix = ERROR %(name)s %(instance)s
logging_default_format_string = %(color)s%(levelname)s %(name)s [-%(color)s] %(instance)s%(color)s%(message)s
logging_context_format_string = %(color)s%(levelname)s %(name)s [%(global_request_id)s %(request_id)s %(project_name)s %(user_name)s%(color)s] %(instance)s%(color)s%(message)s
logging_debug_format_suffix = {{(pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d}}
instances_path = /opt/stack/data/nova/instances
state_path = /opt/stack/data/nova
shutdown_timeout = 0
metadata_listen = 0.0.0.0
osapi_compute_listen = 0.0.0.0
instance_name_template = instance-%08x
my_ip = 192.168.10.9
rootwrap_config = /etc/nova/rootwrap.conf
allow_resize_to_same_host = True
debug = True

[wsgi]
api_paste_config = /etc/nova/api-paste.ini

[filter_scheduler]
track_instance_changes = False
enabled_filters = AvailabilityZoneFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,SameHostFilter,DifferentHostFilter

[scheduler]
workers = 2

[neutron]
region_name = RegionOne
auth_strategy = keystone
project_domain_name = Default
project_name = service
user_domain_name = Default
password = secret
username = neutron
auth_url = http://192.168.10.8/identity
auth_type = password
default_floating_pool = public

[key_manager]
fixed_key = bae3516cc1c0eb18b05440eba8012a4a880a2ee04d584a9c1579445e675b12defdc716ec
backend = nova.keymgr.conf_key_mgr.ConfKeyManager

[oslo_concurrency]
lock_path = /opt/stack/data/nova

[upgrade_levels]
compute = auto

[oslo_messaging_notifications]
transport_url = rabbit://stackrabbit:secret@192.168.10.8:5672/
driver = messagingv2

[notifications]
notification_format = unversioned

[conductor]
workers = 2

[service_user]
auth_strategy = keystone
project_domain_name = Default
project_name = service
user_domain_name = Default
password = secret
username = nova
auth_url = http://192.168.10.8/identity
auth_type = password
send_service_user_token = True

[libvirt]
live_migration_uri = qemu+ssh://stack@%s/system
cpu_mode = none
virt_type = qemu

[workarounds]
libvirt_disable_apic = True
disable_group_policy_check_upcall = True

[vnc]
server_proxyclient_address = 192.168.10.9
server_listen = 192.168.10.9
novncproxy_base_url = http://192.168.10.8:6080/vnc_auto.html

[spice]
html5proxy_base_url = http://192.168.10.8:6081/spice_auto.html

通过对比在compute节点上， /etc/nova/nova-cpu.conf中要有这一项

[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
user_domain_name = Default
password = secret
username = placement
auth_url = http://192.168.10.8/identity
auth_type = password


lib/nova:function configure_placement_nova_compute {
lib/nova:    iniset $conf placement auth_type "password"
lib/nova:    iniset $conf placement auth_url "$KEYSTONE_SERVICE_URI"
lib/nova:    iniset $conf placement username placement
lib/nova:    iniset $conf placement password "$SERVICE_PASSWORD"
lib/nova:    iniset $conf placement user_domain_name "$SERVICE_DOMAIN_NAME"
lib/nova:    iniset $conf placement project_name "$SERVICE_TENANT_NAME"
lib/nova:    iniset $conf placement project_domain_name "$SERVICE_DOMAIN_NAME"
lib/nova:    iniset $conf placement region_name "$REGION_NAME"

# Configure access to placement from a nova service, usually
# compute, but sometimes conductor.
function configure_placement_nova_compute {
    # Use the provided config file path or default to $NOVA_CONF.
    local conf=${1:-$NOVA_CONF}
    iniset $conf placement auth_type "password"
    iniset $conf placement auth_url "$KEYSTONE_SERVICE_URI"
    iniset $conf placement username placement
    iniset $conf placement password "$SERVICE_PASSWORD"
    iniset $conf placement user_domain_name "$SERVICE_DOMAIN_NAME"
    iniset $conf placement project_name "$SERVICE_TENANT_NAME"
    iniset $conf placement project_domain_name "$SERVICE_DOMAIN_NAME"
    iniset $conf placement region_name "$REGION_NAME"
}

if ! isset ENABLED_SERVICES ; then
    # Keystone - nothing works without keystone
    ENABLED_SERVICES=key
    # Nova - services to support libvirt based openstack clouds
    ENABLED_SERVICES+=,n-api,n-cpu,n-cond,n-sch,n-novnc,n-api-meta
    # Placement service needed for Nova
    ENABLED_SERVICES+=,placement-api,placement-client
    # Glance services needed for Nova
    ENABLED_SERVICES+=,g-api
    # Cinder
    ENABLED_SERVICES+=,c-sch,c-api,c-vol
    # Neutron
    ENABLED_SERVICES+=,q-svc,q-dhcp,q-meta,q-agt,q-l3
    # Dashboard
    ENABLED_SERVICES+=,horizon
    # Additional services
    ENABLED_SERVICES+=,rabbit,tempest,mysql,etcd3,dstat
fi

在stack.sh里面
# create a placement-client fake service to know we need to configure
# placement connectivity. We configure the placement service for nova
# if placement-api or placement-client is active, and n-cpu on the
# same box.
if is_service_enabled placement placement-client; then
    if is_service_enabled n-cpu || is_service_enabled n-sch; then
        configure_placement_nova_compute
    fi
fi

https://cloud.centos.org/centos/7/images/

metadata server成功

namespace里面可以连接

root@devstack-controller:~# ip netns
qdhcp-83a685f7-9673-4a50-a043-1f950e768482 (id: 4)
qrouter-a131cd6f-fb82-4197-9c71-c3d421e61df3 (id: 3)
qdhcp-59734805-75eb-4460-821d-7d538472cd45 (id: 0)

ip netns exec qrouter-a131cd6f-fb82-4197-9c71-c3d421e61df3 ssh -i /root/openstack.pem centos@10.0.0.49

root@devstack-controller:~# ip netns exec qrouter-a131cd6f-fb82-4197-9c71-c3d421e61df3 ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
29: qr-bc2016fc-00: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:14:41:19 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.1/26 brd 10.0.0.63 scope global qr-bc2016fc-00
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe14:4119/64 scope link
       valid_lft forever preferred_lft forever
30: qg-700b1130-29: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:d3:7e:aa brd ff:ff:ff:ff:ff:ff
    inet 172.24.4.117/24 brd 172.24.4.255 scope global qg-700b1130-29
       valid_lft forever preferred_lft forever
    inet 172.24.4.109/32 brd 172.24.4.109 scope global qg-700b1130-29
       valid_lft forever preferred_lft forever
    inet6 2001:db8::1/64 scope global
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fed3:7eaa/64 scope link
       valid_lft forever preferred_lft forever
31: qr-41ff8123-10: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:01:59:93 brd ff:ff:ff:ff:ff:ff
    inet6 fd66:894f:7f3::1/64 scope global
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe01:5993/64 scope link
       valid_lft forever preferred_lft forever
root@devstack-controller:~# ovs-vsctl show
1a861be3-e69d-4bd7-94f7-aa5350d6934c
    Manager "ptcp:6640:127.0.0.1"
        is_connected: true
    Bridge br-ex
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        datapath_type: system
        Port br-ex
            Interface br-ex
                type: internal
        Port phy-br-ex
            Interface phy-br-ex
                type: patch
                options: {peer=int-br-ex}
    Bridge br-tun
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        datapath_type: system
        Port vxlan-c0a80a09
            Interface vxlan-c0a80a09
                type: vxlan
                options: {df_default="true", egress_pkt_mark="0", in_key=flow, local_ip="192.168.10.8", out_key=flow, remote_ip="192.168.10.9"}
        Port br-tun
            Interface br-tun
                type: internal
        Port patch-int
            Interface patch-int
                type: patch
                options: {peer=patch-tun}
    Bridge br-int
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        datapath_type: system
        Port tap79fa2fa9-09
            tag: 2
            Interface tap79fa2fa9-09
                type: internal
        Port qg-700b1130-29
            tag: 4095
            trunks: [4095]
            Interface qg-700b1130-29
                type: internal
        Port qr-bc2016fc-00
            tag: 1
            Interface qr-bc2016fc-00
                type: internal
        Port int-br-ex
            Interface int-br-ex
                type: patch
                options: {peer=phy-br-ex}
        Port patch-tun
            Interface patch-tun
                type: patch
                options: {peer=patch-int}
        Port br-int
            Interface br-int
                type: internal
        Port tap3b87c4a5-3e
            tag: 1
            Interface tap3b87c4a5-3e
                type: internal
        Port qr-41ff8123-10
            tag: 1
            Interface qr-41ff8123-10
                type: internal
    ovs_version: "2.13.8"


root@devstack-controller:~# ip netns exec qrouter-a131cd6f-fb82-4197-9c71-c3d421e61df3 ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
29: qr-bc2016fc-00: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:14:41:19 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.1/26 brd 10.0.0.63 scope global qr-bc2016fc-00
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe14:4119/64 scope link
       valid_lft forever preferred_lft forever
30: qg-700b1130-29: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:d3:7e:aa brd ff:ff:ff:ff:ff:ff
    inet 172.24.4.117/24 brd 172.24.4.255 scope global qg-700b1130-29
       valid_lft forever preferred_lft forever
    inet6 2001:db8::1/64 scope global
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fed3:7eaa/64 scope link
       valid_lft forever preferred_lft forever
31: qr-41ff8123-10: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:01:59:93 brd ff:ff:ff:ff:ff:ff
    inet6 fd66:894f:7f3::1/64 scope global
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe01:5993/64 scope link
       valid_lft forever preferred_lft forever


root@devstack-controller:~# ovs-vsctl show
1a861be3-e69d-4bd7-94f7-aa5350d6934c
    Manager "ptcp:6640:127.0.0.1"
        is_connected: true
    Bridge br-ex
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        datapath_type: system
        Port br-ex
            Interface br-ex
                type: internal
        Port phy-br-ex
            Interface phy-br-ex
                type: patch
                options: {peer=int-br-ex}
    Bridge br-tun
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        datapath_type: system
        Port vxlan-c0a80a09
            Interface vxlan-c0a80a09
                type: vxlan
                options: {df_default="true", egress_pkt_mark="0", in_key=flow, local_ip="192.168.10.8", out_key=flow, remote_ip="192.168.10.9"}
        Port br-tun
            Interface br-tun
                type: internal
        Port patch-int
            Interface patch-int
                type: patch
                options: {peer=patch-tun}
    Bridge br-int
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        datapath_type: system
        Port tap79fa2fa9-09
            tag: 2
            Interface tap79fa2fa9-09
                type: internal
        Port qg-700b1130-29
            tag: 4095
            trunks: [4095]
            Interface qg-700b1130-29
                type: internal
        Port qr-bc2016fc-00
            tag: 1
            Interface qr-bc2016fc-00
                type: internal
        Port int-br-ex
            Interface int-br-ex
                type: patch
                options: {peer=phy-br-ex}
        Port patch-tun
            Interface patch-tun
                type: patch
                options: {peer=patch-int}
        Port br-int
            Interface br-int
                type: internal
        Port tap3b87c4a5-3e
            tag: 1
            Interface tap3b87c4a5-3e
                type: internal
        Port qr-41ff8123-10
            tag: 1
            Interface qr-41ff8123-10
                type: internal
    ovs_version: "2.13.8"


https://www.cnblogs.com/popsuper1982/p/3849822.html

创建新的网卡qg，attach到br-ex

ovs-vsctl -- --if-exists del-port qg-700b1130-29 -- add-port br-ex qg-700b1130-29 -- set Interface qg-700b1130-29 type=internal -- set Interface qg-700b1130-29 external-ids:iface-id=556ca938-e11b-4246-bdc1-ef25c91b7593 -- set Interface qg-556ca938-e1 external-ids:iface-status=active -- set Interface qg-700b1130-29 external-ids:attached-mac=fa:16:3e:68:12:c0

设置网卡mac

ip link set qg-556ca938-e1 address fa:16:3e:68:12:c0

br-ex的连接方式有所改变
OpenStack实践(九):Open vSwitch方式实现floating IP
https://www.yisu.com/jc/25322.html

root@devstack-controller:~# ovs-ofctl dump-flows br-ex
 cookie=0xc0b889cb790d0ee0, duration=782.423s, table=0, n_packets=8098, n_bytes=920156, priority=2,in_port="phy-br-ex" actions=drop
 cookie=0xc0b889cb790d0ee0, duration=782.426s, table=0, n_packets=43, n_bytes=2518, priority=0 actions=NORMAL

root@devstack-controller:~# ovs-ofctl dump-flows br-int
 cookie=0x9dc6d4ee5354f700, duration=875.484s, table=0, n_packets=0, n_bytes=0, priority=65535,dl_vlan=4095 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=875.470s, table=0, n_packets=43, n_bytes=2518, priority=2,in_port="int-br-ex" actions=drop
 cookie=0x9dc6d4ee5354f700, duration=875.486s, table=0, n_packets=12217, n_bytes=1298185, priority=0 actions=resubmit(,60)
 cookie=0x9dc6d4ee5354f700, duration=875.487s, table=23, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=875.484s, table=24, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=797.988s, table=60, n_packets=3954, n_bytes=560540, priority=100,in_port="qr-41ff8123-10" actions=load:0x6->NXM_NX_REG5[],load:0x1->NXM_NX_REG6[],resubmit(,73)
 cookie=0x9dc6d4ee5354f700, duration=797.988s, table=60, n_packets=1363, n_bytes=158534, priority=100,in_port="qr-bc2016fc-00" actions=load:0x4->NXM_NX_REG5[],load:0x1->NXM_NX_REG6[],resubmit(,73)
 cookie=0x9dc6d4ee5354f700, duration=797.988s, table=60, n_packets=3, n_bytes=270, priority=100,in_port="tap79fa2fa9-09" actions=load:0x7->NXM_NX_REG5[],load:0x2->NXM_NX_REG6[],resubmit(,73)
 cookie=0x9dc6d4ee5354f700, duration=797.988s, table=60, n_packets=846, n_bytes=75303, priority=100,in_port="tap3b87c4a5-3e" actions=load:0x3->NXM_NX_REG5[],load:0x1->NXM_NX_REG6[],resubmit(,73)
 cookie=0x9dc6d4ee5354f700, duration=875.485s, table=60, n_packets=5639, n_bytes=467814, priority=3 actions=NORMAL
 cookie=0x9dc6d4ee5354f700, duration=875.483s, table=62, n_packets=0, n_bytes=0, priority=3 actions=NORMAL
 cookie=0x9dc6d4ee5354f700, duration=800.804s, table=71, n_packets=0, n_bytes=0, priority=110,ct_state=+trk actions=ct_clear,resubmit(,71)
 cookie=0x9dc6d4ee5354f700, duration=800.824s, table=71, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=800.820s, table=72, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=797.988s, table=73, n_packets=3949, n_bytes=559950, priority=80,reg5=0x6 actions=resubmit(,94)
 cookie=0x9dc6d4ee5354f700, duration=797.988s, table=73, n_packets=1297, n_bytes=151502, priority=80,reg5=0x4 actions=resubmit(,94)
 cookie=0x9dc6d4ee5354f700, duration=797.988s, table=73, n_packets=3, n_bytes=270, priority=80,reg5=0x7 actions=resubmit(,94)
 cookie=0x9dc6d4ee5354f700, duration=797.988s, table=73, n_packets=841, n_bytes=74421, priority=80,reg5=0x3 actions=resubmit(,94)
 cookie=0x9dc6d4ee5354f700, duration=800.815s, table=73, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=800.812s, table=81, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=800.808s, table=82, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=800.795s, table=91, n_packets=0, n_bytes=0, priority=1 actions=resubmit(,94)
 cookie=0x9dc6d4ee5354f700, duration=800.791s, table=92, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=800.787s, table=93, n_packets=0, n_bytes=0, priority=0 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=800.799s, table=94, n_packets=96, n_bytes=13148, priority=1 actions=NORMAL


   28  ovs-ofctl dump-flows br-ex
   29  ovs-ofctl dump-flows br-int
   30  ovs-ofctl del-flows
   31  ovs-ofctl del-flows br-ex priority=2,in_port="phy-br-ex" actions=drop
   32  ovs-ofctl del-flows br-ex 'priority=2,in_port="phy-br-ex"'
   33  ovs-ofctl del-flows -h
   34  ovs-ofctl del-flows br-ex "priority=2,in_port=\"phy-br-ex\""
   35  ovs-ofctl del-flows br-ex "in_port=\"phy-br-ex\""
   36  ovs-ofctl del-flows br-int "in_port=\"int-br-ex\""
   37  ovs-ofctl dump-flows br-ex
   38  ovs-ofctl dump-flows br-int
   39  ovs-ofctl del-flows br-int "dl_vlan=4095"
   40  ovs-ofctl dump-flows br-int
   41  tcpdump -n -i br-int
   42  ovs-vsctl show
   43  ovs-vsctl set port qg-700b1130-29 VLAN_mode=native-untagged
   44  ovs-vsctl show
   45  ovs-vsctl remove port qg-700b1130-29 tag 4095
   46  ovs-vsctl show
   47  ovs-vsctl remove port qg-700b1130-29 trunk 4095

发现默认的flow里面的规则是drop掉的
root@devstack-controller:~# ovs-ofctl dump-flows br-ex
 cookie=0xc0b889cb790d0ee0, duration=782.423s, table=0, n_packets=8098, n_bytes=920156, priority=2,in_port="phy-br-ex" actions=drop
root@devstack-controller:~# ovs-ofctl dump-flows br-int
 cookie=0x9dc6d4ee5354f700, duration=875.484s, table=0, n_packets=0, n_bytes=0, priority=65535,dl_vlan=4095 actions=drop
 cookie=0x9dc6d4ee5354f700, duration=875.470s, table=0, n_packets=43, n_bytes=2518, priority=2,in_port="int-br-ex" actions=drop

VID（VLAN ID）：长度为12bit，取值范围是0~4095，其中0表示该帧不属于任何一个VLAN，而4095是保留值，不能给用户使用，所以实际可用的VLAN ID一共为4094个(1 ~ 4094)。

删除这几个flow
   35  ovs-ofctl del-flows br-ex "in_port=\"phy-br-ex\""
   36  ovs-ofctl del-flows br-int "in_port=\"int-br-ex\""
   39  ovs-ofctl del-flows br-int "dl_vlan=4095"

在br-int上
        Port qg-700b1130-29
            tag: 4095
            trunks: [4095]
            Interface qg-700b1130-29
                type: internal

把tag去掉
   45  ovs-vsctl remove port qg-700b1130-29 tag 4095
   47  ovs-vsctl remove port qg-700b1130-29 trunk 4095

通了

可是devstack为什么要这样配置呢？